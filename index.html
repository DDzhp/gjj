<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>⚡️新新小朋友的工具集⚡️</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 日志解码功能 - 原文件: ./logDecode.js - 已集成到HTML中 -->
    <script>

//日志解码功能开始 - 原文件: ./logDecode.js - 已集成到HTML中
function log_decode(string){
    if(!string || string.length != 116 && string.length != 104){
        return '请输入正确的日志';
    }
    let replaceMsg = string.replace(/\s/g,'');
    let deviceid = deviceid_state(replaceMsg.length == 116?replaceMsg.substring(2,10):replaceMsg.substring(2,10));
    let tap_code = tap(parseInt(replaceMsg.substring(10,12),16));
    let type_msg = instructions(parseInt(replaceMsg.substring(12,14),16));
    let device_state = parseInt(replaceMsg.substring(14,16),16);
    let electric_quantity = replaceMsg.substring(16,18);
    let water_temperature = replaceMsg.substring(18,20);
    let water_flow = current_flow(replaceMsg.length == 116?replaceMsg.substring(20,28):replaceMsg.substring(20,28));
    let recharge_flow_msg = recharge_flow(replaceMsg.length == 116?replaceMsg.substring(28,36):replaceMsg.substring(28,36));
    let battery_electric_quantity = replaceMsg.substring(36,38);
    let water_temperature2 = replaceMsg.substring(38,40);
    let data_num = replaceMsg.substring(40,42);
    let software_version = replaceMsg.substring(42,44);
    let hardware_version = replaceMsg.substring(44,46);
    let payment_mode = replaceMsg.substring(46,48);
    let communication_mode = replaceMsg.substring(48,50);
    let number1 = replaceMsg.substring(50,58);
    let number2 = replaceMsg.substring(58,66);
    let number3 = replaceMsg.substring(66,74);
    let number4 = replaceMsg.substring(74,82);
    let number5 = replaceMsg.substring(82,90);
    let number6 = replaceMsg.substring(90,98);
    let number7 = replaceMsg.substring(98,106);
    let number8 = replaceMsg.substring(106,114);
    let crc = replaceMsg.substring(114,116);
    
    let result = '';
    let msg = '';
    if(deviceid){
        result = result + '设备编号：'+deviceid + '<br>';
    }
    if(tap_code){
        result = result + tap_code + '<br>';
    }
    if(type_msg){
        result = result + type_msg + '<br>';
    }
    if(device_state == 0){
        result = result + '设备状态：'+ '正常' + '<br>';
    }
    if(device_state == 1){
        result = result + '设备状态：'+ '运行中' + '<br>';
    }
    if(device_state == 2){
        result = result + '设备状态：'+ '故障' + '<br>';
    }
    if(device_state == 3){
        result = result + '设备状态：'+ '预警' + '<br>';
    }
    if(device_state == 4){
        result = result + '设备状态：'+ '离线' + '<br>';
    }
    if(parseInt(electric_quantity,16) < 20){
        result = result + '设备电量：'+ parseInt(electric_quantity,16) + '% （电量不足，请充电）' + '<br>';
    }
    else{
        result = result + '设备电量：'+ parseInt(electric_quantity,16) + '%' + '<br>';
    }
    if(device_state ==1 && parseInt(water_temperature,16) >10){
        result = result + '当前水温：'+ parseInt(water_temperature,16) + '°C' + '<br>';
    }
    if(water_flow){
        result = result + water_flow + '<br>';
    }
    if(parseInt(battery_electric_quantity,16) < 20){
        result = result + '电池电量：'+ parseInt(battery_electric_quantity,16) + '% （电量不足，请充电）' + '<br>';
    }
    else{
        result = result + '电池电量：'+ parseInt(battery_electric_quantity,16) + '%' + '<br>';
    }
    if(device_state ==1 && parseInt(water_temperature2,16) >10){
        result = result + '原水水温：'+ parseInt(water_temperature2,16) + '°C' + '<br>';
    }
    if(parseInt(software_version,16) > 0){
        result = result + '软件版本：'+ parseInt(software_version,16) + '<br>';
    }
    if(parseInt(hardware_version,16) > 0){
        result = result + '硬件版本：'+ parseInt(hardware_version,16) + '<br>';
    }
    if(parseInt(payment_mode,16) ==1){
        result = result + '支付模式：'+ '扫码支付' + '<br>';
    }
    else if(parseInt(payment_mode,16) ==2){
        result = result + '支付模式：'+ 'IC卡支付' + '<br>';
    }
    else if(parseInt(payment_mode,16) ==3){
        result = result + '支付模式：'+ '扫码+IC卡支付' + '<br>';
    }
    if(parseInt(communication_mode,16) ==1){
        result = result + '通讯方式：'+ '4G' + '<br>';
    }
    else if(parseInt(communication_mode,16) ==2){
        result = result + '通讯方式：'+ '蓝牙' + '<br>';
    }
    else if(parseInt(communication_mode,16) ==3){
        result = result + '通讯方式：'+ '4G+蓝牙' + '<br>';
    }
    else if(parseInt(communication_mode,16) ==4){
        result = result + '通讯方式：'+ 'WiFi' + '<br>';
    }
    // 水控系统日志格式
    if(type_msg.indexOf('水控系统') >=0){
        let number1 = parseInt(replaceMsg.length == 116?replaceMsg.substring(62,70):replaceMsg.substring(50,58),16);
        let msg1 = residual_flow(replaceMsg.substring(48,50),number1);
        if(msg1){
            result = result + msg1 + '<br>';
        }
        let number2 = parseInt(replaceMsg.length == 116?replaceMsg.substring(70,78):replaceMsg.substring(58,66),16);
        let msg2 = recharge_flow(replaceMsg.length == 116?replaceMsg.substring(70,78):replaceMsg.substring(58,66));
        if(msg2){
            result = result + msg2 + '<br>';
        }
    }
    // 智能锁系统日志格式
    if(type_msg.indexOf('智能锁') >=0){
        let number1 = replaceMsg.substring(50,58);
        let msg1 = residual_days(replaceMsg.substring(48,50),parseInt(number1,16));
        if(msg1){
            result = result + msg1 + '<br>';
        }
        let number2 = replaceMsg.substring(58,66);
        let msg2 = recharge_days(replaceMsg.substring(48,50),parseInt(number2,16));
        if(msg2){
            result = result + msg2 + '<br>';
        }
    }
    // 水处理系统日志格式
    if(type_msg.indexOf('水处理') >=0){
        let msg1 = pure_tds(replaceMsg.substring(48,50),parseInt(replaceMsg.substring(50,58),16));
        if(msg1){
            result = result + msg1 + '<br>';
        }
        let msg2 = raw_tds(replaceMsg.substring(48,50),parseInt(replaceMsg.substring(58,66),16));
        if(msg2){
            result = result + msg2 + '<br>';
        }
        let msg3 = one_actual(replaceMsg.substring(48,50),parseInt(replaceMsg.substring(66,74),16));
        if(msg3){
            result = result + msg3 + '<br>';
        }
        let msg4 = two_actual(replaceMsg.substring(48,50),parseInt(replaceMsg.substring(74,82),16));
        if(msg4){
            result = result + msg4 + '<br>';
        }
        let msg5 = three_actual(replaceMsg.substring(48,50),parseInt(replaceMsg.substring(82,90),16));
        if(msg5){
            result = result + msg5 + '<br>';
        }
        let msg6 = four_actual(replaceMsg.substring(48,50),parseInt(replaceMsg.substring(90,98),16));
        if(msg6){
            result = result + msg6 + '<br>';
        }
        let msg7 = five_actual(replaceMsg.substring(48,50),parseInt(replaceMsg.substring(98,106),16));
        if(msg7){
            result = result + msg7 + '<br>';
        }
        let msg8 = one_maximum(replaceMsg.substring(48,50),replaceMsg.substring(50,58));
        if(msg8){
            result = result + msg8 + '<br>';
        }
        let msg9 = two_maximum(replaceMsg.substring(48,50),replaceMsg.substring(58,66));
        if(msg9){
            result = result + msg9 + '<br>';
        }
        let msg10 = three_maximum(replaceMsg.substring(48,50),replaceMsg.substring(66,74));
        if(msg10){
            result = result + msg10 + '<br>';
        }
        let msg11 = four_maximum(replaceMsg.substring(48,50),replaceMsg.substring(74,82));
        if(msg11){
            result = result + msg11 + '<br>';
        }
        let msg12 = five_maximum(replaceMsg.substring(48,50),replaceMsg.substring(82,90));
        if(msg12){
            result = result + msg12 + '<br>';
        }
    }
    
    // 通用数据处理
    if(!result || result == '' || type_msg.indexOf('水控系统') <0 && type_msg.indexOf('智能锁') <0 && type_msg.indexOf('水处理') <0){
        let msg1 = residual_flow(replaceMsg.substring(48,50),parseInt(number1,16));
        if(msg1){
            result = result + msg1 + '<br>';
        }
        let msg2 = recharge_flow(number2);
        if(msg2){
            result = result + msg2 + '<br>';
        }
        let msg3 = used_flow(replaceMsg.substring(48,50),parseInt(number3,16));
        if(msg3){
            result = result + msg3 + '<br>';
        }
        let msg4 = pure_tds(replaceMsg.substring(48,50),parseInt(number4,16));
        if(msg4){
            result = result + msg4 + '<br>';
        }
        let msg5 = raw_tds(replaceMsg.substring(48,50),parseInt(number5,16));
        if(msg5){
            result = result + msg5 + '<br>';
        }
        let msg6 = one_actual(replaceMsg.substring(48,50),parseInt(number3,16));
        if(msg6){
            result = result + msg6 + '<br>';
        }
        let msg7 = two_actual(replaceMsg.substring(48,50),parseInt(number4,16));
        if(msg7){
            result = result + msg7 + '<br>';
        }
        let msg8 = three_actual(replaceMsg.substring(48,50),parseInt(number5,16));
        if(msg8){
            result = result + msg8 + '<br>';
        }
        let msg9 = four_actual(replaceMsg.substring(48,50),parseInt(number6,16));
        if(msg9){
            result = result + msg9 + '<br>';
        }
        let msg10 = five_actual(replaceMsg.substring(48,50),parseInt(number7,16));
        if(msg10){
            result = result + msg10 + '<br>';
        }
        let msg11 = one_maximum(replaceMsg.substring(48,50),number3);
        if(msg11){
            result = result + msg11 + '<br>';
        }
        let msg12 = two_maximum(replaceMsg.substring(48,50),number4);
        if(msg12){
            result = result + msg12 + '<br>';
        }
        let msg13 = three_maximum(replaceMsg.substring(48,50),number5);
        if(msg13){
            result = result + msg13 + '<br>';
        }
        let msg14 = four_maximum(replaceMsg.substring(48,50),number6);
        if(msg14){
            result = result + msg14 + '<br>';
        }
        let msg15 = five_maximum(replaceMsg.substring(48,50),number7);
        if(msg15){
            result = result + msg15 + '<br>';
        }
        let msg16 = time(number8);
        if(msg16){
            result = result + msg16 + '<br>';
        }
        
        
    }
    return result;
}
function instructions(number){//指令解析
    switch(number){
        case 0x01:{return '指令类型：'+'通用上报';}
        case 0x02:{return '指令类型：'+'状态上报';}
        case 0x03:{return '指令类型：'+'故障上报';}
        case 0x04:{return '指令类型：'+'预警上报';}
        case 0x05:{return '指令类型：'+'消费上报';}
        case 0x06:{return '指令类型：'+'充值上报';}
        case 0x07:{return '指令类型：'+'参数设置';}
        case 0x08:{return '指令类型：'+'参数设置回执';}
        case 0x09:{return '指令类型：'+'查询指令';}
        case 0x0a:{return '指令类型：'+'查询指令';}
        case 0x0b:{return '指令类型：'+'查询指令回执';}
        case 0x0c:{return '指令类型：'+'查询指令回执';}
        case 0x10:{return '指令类型：'+'水控系统状态上报';}
        case 0x11:{return '指令类型：'+'水控系统消费上报';}
        case 0x12:{return '指令类型：'+'水控系统充值上报';}
        case 0x13:{return '指令类型：'+'水控系统参数设置';}
        case 0x14:{return '指令类型：'+'水控系统参数设置回执';}
        case 0x20:{return '指令类型：'+'智能锁状态上报';}
        case 0x21:{return '指令类型：'+'智能锁消费上报';}
        case 0x22:{return '指令类型：'+'智能锁充值上报';}
        case 0x23:{return '指令类型：'+'智能锁参数设置';}
        case 0x24:{return '指令类型：'+'智能锁参数设置回执';}
        case 0x30:{return '指令类型：'+'水处理系统状态上报';}
        case 0x31:{return '指令类型：'+'水处理系统消费;上报';}
        case 0x32:{return '指令类型：'+'水处理系统充值上报';}
        case 0x33:{return '指令类型：'+'水处理系统参数设置';}
        case 0x34:{return '指令类型：'+'水处理系统参数设置回执';}
        default:{return '';}
    }
}
function deviceid_state(string){//设备状态解析
    let result = '';
    switch(string.length){
        case 8:{result = string.substring(0,2)+'-'+string.substring(2,4)+'-'+string.substring(4,6)+'-'+string.substring(6,8);}
        case 16:{result = string.substring(0,2)+'-'+string.substring(2,4)+'-'+string.substring(4,6)+'-'+string.substring(6,8)+'-'+string.substring(8,10)+'-'+string.substring(10,12)+'-'+string.substring(12,14)+'-'+string.substring(14,16);}
        default:{result = string;}
    }
    return result;
}
function current_flow(string){//当前流量
    let number = parseInt(string,16);
    if(number > 0){
        return '当前流量：'+number+' ml';
    }
    else{
        return '';
    }
}
function recharge_flow(string){//充值流量
    let number = parseInt(string,16);
    if(number >0){
        return '充值流量：'+number+' L';
    }
    else{
        return '';
    }
}
function recharge_days(string,number){//充值天数
    switch(string.toLowerCase()){
        case '04':{return '冷水阀时间：'+number+'秒/L';}
        case '44':{return '冷水阀时间 回执：'+number+'秒/L';}
        case '80':{return '本次取水等待时间：'+number+' 秒';}
        case '90':{return '本次取水等待时间 回执：'+number+' 秒';}
        case '06':{return '本次出冷水水量：'+number+' ml';}
        case '05':{return '充值天数：'+number+' 天';}
        case '55':{return '剩余天数 回执：'+number+' 天';}
        case '82':{return '加热系统启停温差：'+number;}
        case '92':{return '加热系统启停温差 回执:'+number;}//58
        default:{return '';}
    }
}
function residual_flow(string,number){//剩余流量
    switch(string.toLowerCase()){
        case '04':{return '制水时间：'+number+"分钟/L";}
        case '44':{return '制水时间 回执：'+number+"分钟/L";}
        case '80':{return '连续出水最大时间：'+number;}
        case '90':{return '连续出水最大时间 回执：'+number;}
        case '06':{return '本次消费金额：'+number/100+'元';}
        case '55':{return '剩余流量：'+number+' L';}
        case '0c':{return '剩余流量：'+number+' L';}
        case 'dd':{return '剩余流量：'+number+' L';}
        case '09':{return '剩余流量：'+number+' L';}
        case '99':{return '剩余流量 回执：'+number+' L';}
        case '82':{return '浴霸1启动的温度：'+number;}
        case '92':{return '浴霸1启动的温度 回执:'+number;}//58
        case 'a0':{ return '离线消费金额：'+number/100+'元';}
        default:{return '';}
    }
}
function residual_days(string,number){//剩余天数
    switch(string.toLowerCase()){
        case '04':{return '检修时间：'+number;}
        case '44':{return '检修时间 回执：'+number;}
        case '80':{return '取水暂停时间：'+number;}
        case '90':{return '取水暂停时间 回执：'+number;}
        case '06':{return '';}
        case 'ee':{return '检修时间：'+number;}
        case '55':{return '剩余时间：'+number+' 天';}

        case '0b':{return '剩余时间：'+number+' 天';}
        case 'bb':{return '剩余时间 回执：'+number+' 天';}
        case '09':{return '剩余时间：'+number+' 天';}
        case 'dd':{return '剩余时间：'+number+' 天';}
        case '99':{return '剩余时间 回执：'+number+' 天';}
        case '82':{return '浴霸2启动的温度：'+number;}
        case '92':{return '浴霸2启动的温度 回执:'+number;}//58
        default:{return '';}
    }
}
function used_flow(string,number){//已用流量
    switch(string.toLowerCase()){
        case '04':{return '加热最高温度值：'+number;}
        case '44':{return '加热最高温度值 回执：'+number;}
        case '80':{return '出水热水温度值：'+number;}
        case '90':{return '出水热水温度值 回执：'+number;}
        case '06':{return '已用流量：'+number+' L';}
        case '09':{return '已用流量：'+number+' L';}
        case '99':{return '已用流量： 回执：'+number+' L';}
        case '0c':{return '已用流量：'+number+' L';}
        case 'dd':{return '已用流量：'+number+' L';}
        case '82':{return '浴霸1关闭的温度差：'+number;}
        case '92':{return '浴霸1关闭的温度差 回执:'+number;}//58
        default:{return '';}
    }
}
function used_days(string,number){//已用天数
    switch(string.toLowerCase()){
        case '04':{return '设备制冷最低温度值：'+number;}
        case '44':{return '设备制冷最低温度值 回执：'+number;}
        case '80':{return '';}
        case '06':{return '';}
        case '09':{return '已用天数：'+number;}
        case '99':{return '已用天数 回执：'+number;}
        case '0b':{return '已用天数：'+number;}
        case 'bb':{return '已用天数 回执：'+number;}
        case '82':{return '浴霸2关闭的温度差：'+number;}
        case '92':{return '浴霸2关闭的温度差 回执:'+number;}//58
        default:{return '';}
    }
}
function pure_tds(string,number){//纯水TDS
    switch(string.toLowerCase()){
        case '04':{return '热水费率：'+ number*10 + '升/元';}
        case '44':{return '热水费率 回执：'+ number*10 + '升/元';}
        case '80':{ return '';}
        case '06':{ return '';}
        case '0c':{return '纯水tds：'+number;}
        case 'dd':{return '纯水tds：'+number;}
        default:{return '';}
    }
}
function raw_tds(string,number){//原水TDS
    switch(string.toLowerCase()){
        case '04':{return '冷水费率：'+ number*10 + '升/元';}
        case '44':{return '冷水费率 回执：'+ number*10 + '升/元';}
        case '80':{ return '';}
        case '06':{ return '';}
        case '0c':{return '原水tds：'+number;}
        case 'dd':{return '原水tds：'+number;}
        default:{return '';}
    }
}
function one_actual(string,number){//第一滤芯寿命实时值
    switch(string.toLowerCase()){
        case '04':{return '屏蔽水路：'+ number;}
        case '44':{return '屏蔽水路 回执：'+ number;}
        case '80':{ return '';}// 与下一字节同步
        case '06':{ return '';}// 与下一字节同步
        case 'a0':{ return '';}// 与下一字节同步
        case '07':{return '滤芯1实时：'+ number;}
        case '77':{return '滤芯1实时 回执：'+ number;}
        case '0c':{return '滤芯1实时：'+number;}
        case 'dd':{return '滤芯1实时：'+number;}
        case '09':{return '滤芯1实时：'+number;}
        case '99':{return '滤芯1实时 回执：'+number;}
        case '82':{return '臭氧工作周期：'+number;}
        case '92':{return '臭氧工作周期： 回执:'+number;}//58
        default:{return '';}
    }
}
function two_actual(string,number){//第二滤芯寿命实时值
    switch(string.toLowerCase()){
        case '04':{return '单次最大用量:'+ number;+'/ml';}
        case '44':{return '单次最大用量 回执:'+ number+'/ml';}
        case '80':{ return '剩余金额：'+ parseInt(replaceMsg.length == 116?replaceMsg.substring(62,70):replaceMsg.substring(50,58),16)/100 + '/元';}
        case '90':{ return '剩余金额 回执：'+ parseInt(replaceMsg.length == 116?replaceMsg.substring(62,70):replaceMsg.substring(50,58),16)/100 + '/元';}
        case '06':{ return '剩余金额：'+ parseInt(replaceMsg.length == 116?replaceMsg.substring(62,70):replaceMsg.substring(50,58),16)/100 + '/元';}
        case 'a0':{ return '剩余金额：'+ parseInt(replaceMsg.length == 116?replaceMsg.substring(62,70):replaceMsg.substring(50,58),16)/100 + '/元';}
        case '07':{return '滤芯2实时：'+ number;}
        case '77':{return '滤芯2实时 回执：'+ number;}
        case '0c':{return '滤芯2实时：'+number;}
        case 'dd':{return '滤芯2实时：'+number;}
        case '09':{return '滤芯2实时'+number;}
        case '99':{return '滤芯2实时 回执：'+number;}
        case '82':{return '臭氧工作周期内的启动时间：'+number;}
        case '92':{return '臭氧工作周期内的启动时间： 回执:'+number;}//58
        default:{return '';}
    }
}
function three_actual(string,number){//第三滤芯寿命实时值
    switch(string.toLowerCase()){
        case '04':{return '热水流量计脉冲数：'+ number;}
        case '44':{return '热水流量计脉冲数 回执：'+ number;}
        case 'ee':{return '热水流量计脉冲数：'+ number;}
        case '80':{ return '';}
        case '06':{ return '';}
        case '07':{return '滤芯3实时：'+ number;}
        case '77':{return '滤芯3实时 回执：'+ number;}
        case '0c':{return '滤芯3实时：'+number;}
        case 'dd':{return '滤芯3实时：'+number;}
        case '09':{return '滤芯3实时：'+number;}
        case '99':{return '滤芯3实时： 回执：'+number;}
        default:{return '';}
    }
}
function four_actual(string,number){//第四滤芯寿命实时值
    switch(string.toLowerCase()){
        case '04':{return '热水费率金额：'+number+'分';}
        case '44':{return '热水费率金额(新)：'+number+'分';}
        case '80':{ return '';}
        case '06':{ return '';}
        case '07':{return '滤芯4实时：'+ number;}
        case '77':{return '滤芯4实时 回执：'+ number;}
        case '0c':{return '滤芯4实时：'+number;}
        case 'dd':{return '滤芯4实时：'+number;}
        case '09':{return '滤芯4实时'+number;}
        case '99':{return '滤芯4实时 回执：'+number;}
        default:{return '';}
    }
}
function five_actual(string,number){//第五滤芯寿命实时值
    switch(string.toLowerCase()){
        case '04':{return '热水费率流量：'+number+'ml';}
        case '44':{return '热水费率流量(新)：'+number+'ml';}
        case '80':{ return '';}
        case '06':{ return '';}
        case 'ee':{ return '当前信号值 回执：'+number;}
        case '07':{return '滤芯5实时：'+ number;}
        case '77':{return '滤芯5实时 回执：'+ number;}
        case '0c':{return '滤芯5实时：'+number;}
        case 'dd':{return '滤芯5实时：'+number;}
        case '09':{return '滤芯5实时：'+number;}
        case '99':{return '滤芯5实时： 回执：'+number;}
        default:{return '';}
    }
}
function one_maximum(string,number){//第一滤芯寿命最大值
    switch(string.toLowerCase()){
        case '04':{return 'iccid：'+number + '（最大放水时间：'+parseInt(number,16)+'）';}
        case '44':{return 'iccid：'+number + '（最大放水时间 回执：'+parseInt(number,16)+'）';}
        case '80':{ return '';}
        case '06':{ return '';}
        case 'a0':{ return '';}// 与下一字节同步
        case '07':{return '滤芯1最大：'+ parseInt(number,16);}
        case '77':{return '滤芯1最大 回执：'+ parseInt(number,16);}
        case '09':{return '滤芯1最大'+parseInt(number,16);}
        case '99':{return '滤芯1最大 回执：'+ parseInt(number,16);}
        default:{return '';}
    }
}
function two_maximum(string,number){//第二滤芯寿命最大值
    switch(string.toLowerCase()){
        case '04':{return 'iccid：'+number+'(热水阀时间:'+parseInt(number,16)+'秒/L）';}
        case '44':{return 'iccid：'+number+'(热水阀时间 回执:'+parseInt(number,16)+'秒/L）';}
        case '80':{ return 'IC卡号：' + (replaceMsg.length == 116?replaceMsg.substring(82,90):replaceMsg.substring(70,78));}
        case '90':{ return 'IC卡号 回执：' + (replaceMsg.length == 116?replaceMsg.substring(82,90):replaceMsg.substring(70,78));}
        case '06':{ return 'IC卡号：' + (replaceMsg.length == 116?replaceMsg.substring(82,90):replaceMsg.substring(70,78));}
        case 'a0':{ return 'IC卡号：' + (replaceMsg.length == 116?replaceMsg.substring(82,90):replaceMsg.substring(70,78));}
        case '07':{return '滤芯2最大：'+ parseInt(number,16);}
        case '77':{return '滤芯2最大 回执：'+ parseInt(number,16);}
        case '09':{return '滤芯2最大'+parseInt(number,16);}
        case '99':{return '滤芯2最大 回执：'+ parseInt(number,16);}
        default:{return '';}
    }
}
function three_maximum(string,number){//第三滤芯寿命最大值
    switch(string.toLowerCase()){
        case '04':{return '冷水费率金额(新)：'+parseInt(number,16)+'分';}
        case '44':{return '冷水费率金额(新)：'+parseInt(number,16)+'分';}
        case '80':{ return '剩余流量：'+number;}
        case '90':{ return '剩余流量 回执：'+number;}
        case '06':{ return '';}
        case '07':{return '滤芯3最大：'+ parseInt(number,16);}
        case '77':{return '滤芯3最大 回执：'+ parseInt(number,16);}
        case '09':{return '滤芯3最大'+parseInt(number,16);}
        case '99':{return '滤芯3最大 回执：'+ parseInt(number,16);}
        default:{return '';}
    }
}
function four_maximum(string,number){//第四滤芯寿命最大值
    switch(string.toLowerCase()){
        case '04':{return 'iccid：'+number;}
        case '44':{return '';}
        case '80':{ return '剩余天数：'+number;}
        case '90':{ return '剩余天数 回执：'+number;}
        case '06':{ return '';}
        case '07':{return '滤芯4最大：'+ parseInt(number,16);}
        case '77':{return '滤芯4最大 回执：'+ parseInt(number,16);}
        case '09':{return '滤芯4最大'+parseInt(number,16);}
        case '99':{return '滤芯4最大 回执：'+ parseInt(number,16);}
        default:{return '';}
    }
}
function five_maximum(string,number){//第五滤芯寿命最大值
    switch(string.toLowerCase()){
        case '04':{return '冷水费率流量(新)：'+parseInt(number,16)+'ml';}
        case '44':{return '冷水费率流量(新)：'+parseInt(number,16)+'ml';}
        case '80':{ return '';}
        case '06':{ return '';}
        case 'ee':{ return 'ICCID 号:'+(replaceMsg.length == 116?replaceMsg.substring(82,102):replaceMsg.substring(70,90));}
        case '07':{return '滤芯5最大：'+ parseInt(number,16);}
        case '77':{return '滤芯5最大 回执：'+ parseInt(number,16);}
        case '09':{return '滤芯5最大：'+parseInt(number,16);}
        case '99':{return '滤芯5最大 回执：'+ parseInt(number,16);}
        default:{return '';}
    }
}
function time(number){//北京时间
    switch(number){
        case '09':{return '北京时间：'+number;}
        case '99':{return '北京时间 回执：'+number;}
        case '0b':{return '北京时间：'+number;}
        case 'bb':{return '北京时间 回执：'+number;}
        default:{return '';}
    }
}
function tap(number){//机器类型码
    switch(number){
        case 0:{return '机器类型：'+'家用机，商务机';}
        case 1:{return '机器类型：'+'台面机';}
        case 2:{ return '机器类型：'+'管线机';}
        case 3:{ return '机器类型：'+'售水机，校园机，医院机';}
        default:{return '';}
    }
}
// 日志解码功能结束 - 原文件: ./logDecode.js - 已集成到HTML中
// 声明全局变量 replaceMsg，避免在函数内部引用未定义变量

let replaceMsg = '';
    </script>
    <style>
        /* ===== 全局样式 ===== */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        /* ===== 容器样式 ===== */
        .container {
            max-width: 1300px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        /* ===== 主标题样式 ===== */
        h1 {
            text-align: center;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5em;
            margin: 0 0 30px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* ===== 工具导航栏样式 ===== */
        .tool-switcher {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 20px 0 30px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .tool-switcher button {
            padding: 12px 20px;
            border: 2px solid transparent;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            cursor: pointer;
            border-radius: 25px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .tool-switcher button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s;
        }
        
        .tool-switcher button:hover::before {
            left: 100%;
        }
        
        .tool-switcher button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
            border-color: #007bff;
        }
        
        .tool-switcher button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #5a67d8;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        /* ===== 计算器模块样式 ===== */
        .calculator {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .calculator h2 {
            color: #333;
            margin: 0 0 25px 0;
            font-size: 1.8em;
            text-align: center;
            position: relative;
        }
        
        .calculator h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 2px;
        }
        
        /* ===== 表单元素样式 ===== */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="file"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        input[readonly] {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #666;
            cursor: not-allowed;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        /* ===== 按钮样式 ===== */
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* ===== 日志分析器样式 ===== */
        .log-analysis-tool {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* 结果项容器样式 */
        .result-item {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .result-item:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .result-item.error {
            border: 2px solid #f5c6cb;
        }
        
        /* 错误原始数据区域样式 */
        .error-raw-data {
            padding: 15px;
            background-color: #f8d7da;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
        }
        
        /* 原始日志显示区域样式 */
        .result-header + div {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .log-input-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .buttons-section {
            display: flex;
            gap: 10px;
        }
        
        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .clear-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .clear-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .status-section {
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .status-section.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-section.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .result-section {
            display: flex;
            flex-direction: column;
        }
        
        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1em;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        
        .result-content {
            max-height: 600px;
            overflow-y: auto;
            border: 2px solid #e1e5e9;
            border-top: none;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .data-table th {
            background: #d1ecf1;
            color: #0c5460;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            font-size: 0.75em;
            min-width: 60px;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .data-table th.row-label {
            background: #e9ecef;
            color: #495057;
            font-weight: 700;
            text-align: left;
            min-width: 80px;
            max-width: 100px;
            position: sticky;
            left: 0;
            z-index: 10;
            text-align: center;
            font-size: 1.3em;

        }
        
        .data-table th.range-cell {
            background: #f1f3f4;
            color: #222222;
            font-size: 1.2em;
            font-weight: 500;
        }
        
        .data-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            font-size: 0.7em;
            text-align: center;
            white-space: nowrap;
            min-width: 60px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .data-table td.row-label {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-width: 80px;
            max-width: 100px;
            text-align: center;
            font-size: 1.3em;

        }
        
        .data-table td.data-cell {
            min-width: 60px;
            max-width: 120px;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .data-table tr:hover {
            background-color: #e3f2fd;
        }
        
        .hex-value {
            color: #666666;
            font-weight: bold;
            font-size: 1.5em;
            text-align: center;
        }
        
        .dec-value {
            color: #333333;
            font-size: 1.5em;
            text-align: center;
            font-weight: bold;

        }
        
        .data-type-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 10px;
        }
        
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.65em;
            }
            
            .data-table th, .data-table td {
                padding: 4px 2px;
                min-width: 45px;
                max-width: 80px;
            }
            
            .data-table th.row-label, .data-table td.row-label {
                min-width: 60px;
                max-width: 80px;
            }
        }
        
        @media (max-width: 480px) {
            .data-table th, .data-table td {
                padding: 3px 1px;
                min-width: 35px;
                max-width: 60px;
                font-size: 0.6em;
            }
            
            .data-table th.row-label, .data-table td.row-label {
                min-width: 50px;
                max-width: 70px;
            }
        }
        
        button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:active::before {
            width: 300px;
            height: 300px;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* 主要按钮样式 */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        /* 成功按钮样式 */
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(86, 171, 47, 0.4);
        }
        
        /* 警告按钮样式 */
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        }
        
        /* 危险按钮样式 */
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 65, 108, 0.4);
        }
        
        /* ===== 结果显示区域样式 ===== */
        .result-area {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            min-height: 120px;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.6;
        }
        
        /* ===== 参数解析工具特殊样式 ===== */
        .param-results {
            margin-top: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
        }
        
        .param-group {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        
        .param-column {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .param-column h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        /* ===== 按钮组样式 ===== */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        /* ===== 提示信息样式 ===== */
        .info-box {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffeaa7;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .info-box .title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 8px;
        }
        
        .info-box .content {
            color: #856404;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* ===== 表格样式 ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 1.0em;
        }
        
        .data-table tr:nth-child(even) {
            background: rgba(102, 126, 234, 0.05);
        }
        

        /* ===== 响应式设计 ===== */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            .tool-switcher {
                gap: 5px;
            }
            
            .tool-switcher button {
                padding: 10px 15px;
                font-size: 12px;
            }
            
            .calculator {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .param-group {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2em;
            }
        }
        
        /* ===== 滚动条样式 ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        
        /* ===== 二维码生成器样式 ===== */
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 0;
        }
        
        .qr-item {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 0;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .qr-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }
        
        .qr-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .qr-label {
            word-break: break-all;
            line-height: 1.4;
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }
        
        .api-status, .progress-container, .error-message, .success-message {
            margin: 15px 0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        
        .api-status {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196f3;
            color: #1565c0;
        }
        
        .progress-container {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e9ecef;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .progress-text {
            color: #666;
            font-size: 12px;
            text-align: center;
        }
        
        .error-message {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 2px solid #f44336;
            color: #c62828;
        }
        
        .success-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            color: #2e7d32;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 响应式断点优化 */
        @media (max-width: 1400px) {
            .qr-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 12px;
            }
        }
        
        @media (max-width: 1200px) {
            .qr-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }
        
        @media (max-width: 992px) {
            .qr-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .qr-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
            .qr-item {
                padding: 12px;
            }
            .qr-label {
                font-size: 12px;
            }
        }
        
        @media (max-width: 576px) {
            .qr-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }
            .qr-item {
                padding: 10px;
            }
            .qr-label {
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            .qr-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 6px;
            }
            .qr-item {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧨工具集🧨</h1>
        
        <nav class="tool-switcher">
            <button onclick="showTool('pulseTool')">🔄 脉冲计算器</button>
            <button onclick="showTool('conversionTool')">🔢 进制转换器</button>
            <button onclick="showTool('paramParser')">📋 参数解析</button>
            <button onclick="showTool('iccidTool')">📱 ICCID详情</button>
            <button onclick="showTool('waterValueTool')">💧 洗浴单价</button>
            <button onclick="showTool('waterPriceTool')">🚰 水控单价</button>
            <button onclick="showTool('csv89860Tool')">📊 CSViccid乱码</button>
            <button onclick="showTool('excelTemplateTool')">📋 IC卡号处理</button>
            <button onclick="showTool('qrGeneratorTool')">🔲 二维码生成器</button>
            <button onclick="showTool('logAnalysisTool')">📊 日志分析器</button>
            <button onclick="showTool('logAnalysisTool2')">📊 日志解析器</button>
        </nav>
        
        <!-- IC卡号处理工具模块 -->
        <section id="excelTemplateTool" class="calculator">
            <h2>📋 IC卡号处理</h2>
            <div class="form-group">
                <label>上传Excel文件或拖拽文件到下方：</label>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="height: 150px; padding: 8px; font-size: 14px;">
            
            </div>
            <div class="form-group">
                <label>使用模板：</label>
                <select id="templateSelect">
                    <option value="ic卡入库模板.xls" selected>ic卡入库模板.xls</option>
                </select>
                <div id="templateStatus" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px;">🔄 正在加载远程模板...</div>
            </div>
            <div class="button-group">
                <button onclick="processExcelFile()" class="btn-primary" disabled>📊 处理Excel文件</button>
                <button onclick="clearExcelData()" class="btn-warning">🗑️ 清空数据</button>
            </div>
            <div class="form-group">
                <label>处理状态：</label>
                <div id="excelProcessStatus" class="result-area">请上传Excel文件并选择模板</div>
            </div>
            <div class="form-group">
                <label>数据预览：</label>
                <div id="excelDataPreview" class="result-area" style="max-height: 300px; overflow-y: auto;">等待文件上传...</div>
            </div>
            <div class="info-box">
                <div class="title">💡 使用说明：</div>
                <div class="content">
                    • 支持.xlsx和.xls格式的Excel文件<br>
                    • 使用GitHub Pages/Gitee Pages托管模板文件，稳定可靠<br>
                    • 自动识别A、B列中的水卡号（包含字母）和流水号（纯数字）<br>
                    • 如果首行包含"流水号"、"水卡号"等中文字符，将跳过首行<br>
                    • 处理后的数据将填入远程模板文件中<br>
                    • 水卡号填入模板A列（从A2开始），流水号填入B列（从B2开始）<br><br>
                    🔧 <strong>配置模板文件步骤：</strong><br>
                    1️⃣ 在GitHub上创建一个公开仓库<br>
                    2️⃣ 上传`ic卡入库模板.xls`文件到仓库根目录<br>
                    3️⃣ 在仓库Settings中启用GitHub Pages<br>
                    4️⃣ 获取模板文件的公开URL（如：https://username.github.io/repo/ic卡入库模板.xls）<br>
                    5️⃣ 修改代码中的templateUrl为实际URL<br><br>
                    🎆 <strong>Gitee Pages备用方案（国内访问更快）：</strong><br>
                    1️⃣ 在Gitee上创建一个公开仓库<br>
                    2️⃣ 上传`ic卡入库模板.xls`文件到仓库根目录<br>
                    3️⃣ 在仓库的"服务"中选择"Gitee Pages"<br>
                    4️⃣ 选择部署分支（通常为master），点击"启动"<br>
                    5️⃣ 成功后获取URL（如：https://username.gitee.io/repo/ic卡入库模板.xls）<br>
                    6️⃣ 将此URL设置为fallbackUrls[0]<br><br>
                    🌍 <strong>如果Gitee Pages不可用，替代方案：</strong><br>
                    • <strong>jsDelivr CDN</strong>: https://cdn.jsdelivr.net/gh/用户名/仓库名/文件名<br>
                    • <strong>GitHub Raw</strong>: https://raw.githubusercontent.com/用户名/仓库名/main/文件名<br>
                    • <strong>Coding.net</strong>: https://用户名.coding.net/p/项目名/d/仓库名/git/raw/master/文件名
                </div>
            </div>
            <div class="info-box" style="border-color: #007bff; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                <div class="title" style="color: #1565c0;">🌐 当前多重备用配置：</div>
                <div class="content" style="color: #1565c0; font-size: 12px;">
                    • 主URL：<code>GitHub Raw</code><br>
                    • 备用URL 1：<code>GitHub Pages</code><br>
                    • 备用URL 2：<code>Gitee Pages</code><br>
                    • 备用URL 3：<code>jsDelivr CDN</code><br>
                    • 备用URL 4：<code>Coding.net</code><br>
                    • 状态：✅ 多重保障，高可用性
                </div>
            </div>
        </section>
        
        <section id="pulseTool" class="calculator" style="display:none;">
            <h2>🔄 脉冲参数计算器</h2>
            <div class="form-group">
                <label>系统设置脉冲数：</label>
                <input type="number" id="systemPulses" min="0" step="1" placeholder="请输入正整数">
            </div>
            
            <div class="form-group">
                <label>系统显示出水量(ml)：</label>
                <input type="number" id="systemWater" min="0" step="0.01" placeholder="请输入正数">
            </div>
            
            <div class="form-group">
                <label>实际出水量(ml)：</label>
                <input type="number" id="actualWater" placeholder="请输入正数">
            </div>
            
            <div class="form-group">
                <label>实际脉冲数：</label>
                <input type="number" id="actualPulses" readonly placeholder="自动计算结果">
            </div>
        </section>

        <section id="conversionTool" class="calculator" style="display:none;">
            <h2>🔢 进制转换工具</h2>
            <div class="form-group">
                <label>十进制：</label>
                <input type="text" id="decimalInput" placeholder="输入0-9数字">
            </div>
            
            <div class="form-group">
                <label>十六进制：</label>
                <input type="text" id="hexInput" placeholder="输入0-9/A-F">
            </div>
        </section>
        
        <section id="paramParser" class="calculator" style="display:none;">
            <h2>📋 参数解析工具</h2>
            <div class="form-group">
                <label>参数文本：</label>
                <textarea id="paramInput" placeholder="粘贴参数文本... 示例：
1脉冲1250，检修720，大/1通道/热水费率[元/升]0.5"></textarea>
            </div>
            <div class="button-group">
                <button onclick="parseParams()" class="btn-primary">🔍 解析参数</button>
            </div>
            
            <div class="param-results">
                <div class="param-group">
                    <div class="param-column">
                        <h4>标准格式：</h4>
                        <div id="formattedParams"></div>
                    </div>
                </div>
            </div>
        </section>
        

        
        <!-- ICCID详情工具模块 -->
        <section id="iccidTool" class="calculator" style="display:none;">
            <h2>ICCID详情工具</h2>
            <div class="form-group">
                <textarea id="iccidInput" placeholder="粘贴ICCID范围文本... 示例：
898604C6062290468489到898604C6062290468491(3张)
898604C6062290469305到898604C6062290469309（5张）
898604D00623D0047511'
898604D00623D0047313'
898604D00623D0046269'

支持同时解析两种格式的ICCID
按Ctrl+Enter可以换行
" style="width:100%; height:100px; padding:8px; margin-bottom:10px;"></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button onclick="parseIccids()" style="background: #007bff; color: white; padding: 8px 20px;">解析数据</button>
                <button onclick="formatIccids()" style="background: #28a745; color: white; padding: 8px 20px;">修改格式</button>
                <button onclick="addQuotesToIccids()" style="background: #ffc107; color: black; padding: 8px 20px;">恢复格式</button>
            </div>
            
            <div class="form-group">
                <label>解析结果：</label>
                <textarea id="iccidResult" style="width:100%; height:200px; padding:8px;"></textarea>
            </div>
        </section>

        <section id="waterValueTool" class="calculator" style="display:none;">
            <h2>💧 洗浴水控 金额水量换算</h2>
            <div class="form-group">
                <label>金额 (元):</label>
                <input type="number" id="amount" step="0.01" placeholder="输入金额" oninput="calculateWaterValue()">
            </div>
            <div class="form-group">
                <label>水量 (毫升):</label>
                <input type="number" id="waterVolume" placeholder="输入水量" oninput="calculateWaterValue()">
            </div>
            <div class="form-group">
                <label>1分钱对应水量 (毫升):</label>
                <input type="number" id="pricePerMl" step="0.01" placeholder="输入1分钱对应的毫升数" oninput="calculateWaterValue()">
            </div>
            <div class="form-group">
                <label>换算结果：</label>
                <div id="waterValueResult" class="result-area">
                    <div id="waterCalculations">请输入任意两个参数进行计算</div>
                </div>
            </div>
        </section>

        <section id="waterPriceTool" class="calculator" style="display:none;">
            <h2>🚰 共享单价计算器</h2>
            <div class="form-group">
                <label>水量 (毫升):</label>
                <input type="number" id="waterVolume2" step="0.01" placeholder="例如：787" oninput="calculateWaterPrice()">
            </div>
            <div class="form-group">
                <label>消费金额 (元):</label>
                <input type="number" id="amount2" step="0.0001" placeholder="例如：0.2385" oninput="calculateWaterPrice()">
            </div>
            <div class="form-group">
                <label>1升水单价 (元/升):</label>
                <input type="number" id="pricePerLiter" step="0.0001" placeholder="例如：0.3030" oninput="calculateWaterPrice()">
            </div>
            <div class="form-group">
                <label>计算结果：</label>
                <div id="waterPriceResult" class="result-area">
                    <div id="waterPriceCalculations">请输入任意两个参数进行计算</div>
                </div>
            </div>
        </section>
        
        <!-- CSV/Excel IMEI/ICCID 科学计数法处理工具模块 -->
        <section id="csv89860Tool" class="calculator" style="display:none;">
                <h2>📊 CSV/Excel IMEI/ICCID 处理工具</h2>
                <div class="form-group">
                    <label>上传文件（支持CSV、XLS、XLSX格式）：</label>
                    <input type="file" id="csvFileInput" accept=".csv,.xls,.xlsx" style="height: 150px; padding: 8px; font-size: 14px;">
                </div>
                <button onclick="processCSVFile()" disabled>处理文件</button>
                <div class="form-group">
                    <label>处理状态：</label>
                    <div id="csvProcessStatus" style="min-height: 40px;">请选择文件进行处理</div>
                </div>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin-top: 15px;">
                    <div style="font-weight: 600; color: #856404; margin-bottom: 5px;">💡 使用说明：</div>
                    <div style="color: #856404; font-size: 14px;">
                        • 支持CSV、Excel(.xls/.xlsx)格式文件处理<br>
                        • 自动在所有"89860"开头的值前添加英文单引号<br>
                        • 自动在所有"86"开头的15位数字(IMEI)前添加英文单引号<br>
                        • 自动在所有长数字(可能被Excel转为科学计数法)前添加英文单引号<br>
                        • 处理完成后自动下载修改后的文件
                    </div>
                </div>
        </section>

    </div>

    <script>
        // 全局变量
        let excelData = null;
        let parsedData = { waterCardNumbers: [], serialNumbers: [] };
        let uploadedFileName = '';
        let templateWorkbook = null;
        let loadedTemplates = new Map(); // 存储已加载的模板文件
        
        // 远程模板配置（多重备用方案）
        const remoteTemplateConfig = {
            // 🔗 主方案使用GitHub Raw，更稳定可靠
            templateUrl: 'https://raw.githubusercontent.com/DDzhp/ICkamuban/main/ic卡入库模板.xls',
            templateName: 'ic卡入库模板.xls',
            // 多个备用URL（按优先级排序）
            fallbackUrls: [
                'https://DDzhp.github.io/ICkamuban/ic卡入库模板.xls',  // GitHub Pages
                'https://raw.githubusercontent.com/DDzhp/ICkamuban/main/ic卡入库模板.xls',  // Gitee Pages
                'https://cdn.jsdelivr.net/gh/DDzhp/ICkamuban/ic卡入库模板.xls',  // jsDelivr CDN
                'https://your-username.coding.net/p/your-project/d/your-repo/git/raw/master/ic卡入库模板.xls'  // Coding.net
            ]
        };
        
        // 从远程URL加载模板文件（支持多重备用）
        async function loadRemoteTemplate() {
            const statusDiv = document.getElementById('templateStatus');
            const { templateUrl, templateName, fallbackUrls } = remoteTemplateConfig;
            
            statusDiv.innerHTML = '🔄 正在从远程服务器加载模板...';
            
            // 所有要尝试的URL列表
            const urlsToTry = [templateUrl, ...fallbackUrls];
            let lastError = null;
            
            for (let i = 0; i < urlsToTry.length; i++) {
                const currentUrl = urlsToTry[i];
                if (!currentUrl || currentUrl.includes('your-username')) {
                    continue; // 跳过未配置的URL
                }
                
                try {
                    statusDiv.innerHTML = `🔄 正在尝试第${i + 1}个服务器: ${getServerName(currentUrl)}...`;
                    
                    const response = await fetch(currentUrl, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'default'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    // 获取文件数据
                    const arrayBuffer = await response.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    
                    // 使用XLSX读取模板
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 验证工作簿
                    if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('模板文件格式无效');
                    }
                    
                    // 存储模板工作簿和来源信息
                    loadedTemplates.set(templateName, {
                        workbook: workbook,
                        fileName: templateName,
                        fileData: data,
                        source: `${getServerName(currentUrl)} - ${currentUrl}`,
                        loadedAt: new Date().toISOString()
                    });
                    
                    statusDiv.innerHTML = `✅ 远程模板加载成功: ${templateName}<br>` +
                        `📊 包含 ${workbook.SheetNames.length} 个工作表<br>` +
                        `🌐 来源: ${getServerName(currentUrl)} (第${i + 1}个服务器)<br>` +
                        `🔗 当前URL: <code style="font-size:11px;color:#666;">${currentUrl}</code>`;
                    
                    console.log('远程模板加载成功:', {
                        name: templateName,
                        sheets: workbook.SheetNames,
                        size: `${(data.length / 1024).toFixed(2)}KB`,
                        source: currentUrl
                    });
                    
                    // 启用处理按钮
                    updateProcessButton();
                    
                    return; // 成功后退出
                    
                } catch (error) {
                    lastError = error;
                    console.warn(`第${i + 1}个服务器失败:`, currentUrl, error.message);
                    
                    if (i < urlsToTry.length - 1) {
                        statusDiv.innerHTML = `⚠️ ${getServerName(currentUrl)}失败，正在尝试下一个服务器...`;
                        await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
                    }
                }
            }
            
            // 所有URL都失败
            console.error('所有远程模板加载失败:', lastError);
            statusDiv.innerHTML = `❌ 所有远程模板都加载失败<br>` +
                `📝 请检查以下事项：<br>` +
                `• 确保模板文件已正确上传<br>` +
                `• 检查URL配置是否正确<br>` +
                `• 确保网络连接正常<br>` +
                `• 尝试使用下面的替代方案<br>` +
                `🔗 尝试的URL列表: <details><summary>点击查看</summary><pre style="font-size:10px;">${urlsToTry.filter(url => url && !url.includes('your-username')).join('\n')}</pre></details>`;
            
            // 禁用处理按钮
            updateProcessButton();
        }
        
        // 获取服务器名称
        function getServerName(url) {
            if (url.includes('github.io')) return 'GitHub Pages';
            if (url.includes('gitee.io')) return 'Gitee Pages';
            if (url.includes('coding.net')) return 'Coding.net';
            if (url.includes('jsdelivr.net')) return 'jsDelivr CDN';
            if (url.includes('githubusercontent.com')) return 'GitHub Raw';
            return '未知服务器';
        }
        
        // 工具切换函数
        function showTool(toolId) {
            document.querySelectorAll('.calculator').forEach(tool => {
                tool.style.display = 'none';
            });
            
            document.getElementById(toolId).style.display = 'block';
            
            document.querySelectorAll('.tool-switcher button').forEach(btn => {
                btn.classList.remove('active');
            });
            // 找到对应的按钮并添加active类
            const activeButton = document.querySelector(`.tool-switcher button[onclick="showTool('${toolId}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // ===== Excel模板处理相关函数 =====
        
        // 加载模板文件列表
        const templatePath = 'ic卡入库模板.xls';
        // 加载指定路径的模板
        async function loadSpecificTemplate() {
            const templateName = 'ic卡入库模板.xls';
            const statusDiv = document.getElementById('templateStatus');
            
            try {
                // 首先尝试从指定绝对路径加载模板文件
                let response;
                let usedPath;
                
                try {
                    response = await fetch(templatePath);
                    usedPath = templatePath;
                } catch (error) {
                    // 绝对路径失败，尝试相对路径
                    response = await fetch(templateName);
                    usedPath = templateName;
                }
                
                if (!response.ok) {
                    throw new Error(`无法加载模板文件: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // 存储模板工作簿
                loadedTemplates.set(templateName, {
                    workbook: workbook,
                    fileName: templateName,
                    fileData: data
                });
                
                statusDiv.innerHTML = `✅ 已成功加载模板: ${usedPath}`;
                
            } catch (error) {
                console.error('加载模板失败:', error);
                statusDiv.innerHTML = `⚠️ 加载模板失败: ${error.message}<br>请确保本地服务器运行且模板文件可访问: ${templatePath}`;
            }
        }
        async function loadTemplateList() {
            // 如果已经有加载的模板，显示它们
            if (loadedTemplates.size > 0) {
                renderTemplateOptions();
            } else {
                // 提示用户加载模板
                const statusDiv = document.getElementById('excelProcessStatus');
                statusDiv.innerHTML = '请点击“加载模板文件夹”按钮来选择模板文件';
            }
        }
        
        // 处理模板文件上传
        function handleTemplateUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('excelProcessStatus');
            statusDiv.innerHTML = '正在加载模板文件...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    templateWorkbook = XLSX.read(data, { type: 'array' });
                    
                    // 更新选择框显示已上传的模板
                    const select = document.getElementById('templateSelect');
                    const uploadedOption = document.createElement('option');
                    uploadedOption.value = 'uploaded';
                    uploadedOption.textContent = `📄 ${file.name} (已上传)`;
                    uploadedOption.selected = true;
                    
                    // 移除之前的上传选项
                    const existingUploaded = select.querySelector('option[value="uploaded"]');
                    if (existingUploaded) {
                        existingUploaded.remove();
                    }
                    
                    select.appendChild(uploadedOption);
                    
                    statusDiv.innerHTML = `模板文件 "${file.name}" 加载成功`;
                    updateProcessButton();
                    
                } catch (error) {
                    statusDiv.innerHTML = `模板文件加载失败: ${error.message}`;
                    templateWorkbook = null;
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 读取Excel文件
        function readExcelFile(file) {
            const statusDiv = document.getElementById('excelProcessStatus');
            const previewDiv = document.getElementById('excelDataPreview');
            
            // 保存上传文件名
            uploadedFileName = file.name;
            
            statusDiv.innerHTML = '正在读取Excel文件...';
            previewDiv.innerHTML = '正在解析文件内容...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    excelData = jsonData;
                    analyzeExcelData(jsonData);
                    
                } catch (error) {
                    statusDiv.innerHTML = `读取文件失败: ${error.message}`;
                    previewDiv.innerHTML = '文件解析失败';
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 分析Excel数据
        function analyzeExcelData(data) {
            const statusDiv = document.getElementById('excelProcessStatus');
            const previewDiv = document.getElementById('excelDataPreview');
            
            try {
                if (!data || data.length === 0) {
                    statusDiv.innerHTML = '文件为空或无有效数据';
                    return;
                }
                
                let startRow = 0;
                let waterCardCol = -1;
                let serialCol = -1;
                
                // 检查首行是否包含中文字符
                const firstRow = data[0] || [];
                const hasChineseInFirstRow = firstRow.some(cell => 
                    cell && /[\u4e00-\u9fa5]/.test(cell.toString())
                );
                
                if (hasChineseInFirstRow) {
                    startRow = 1;
                    statusDiv.innerHTML = '检测到首行包含中文，将从第二行开始处理';
                } else {
                    startRow = 0;
                    statusDiv.innerHTML = '首行不包含中文，从第一行开始处理';
                }
                
                // 分析A、B列数据类型
                const sampleSize = Math.min(10, data.length - startRow);
                let colAHasLetters = false;
                let colBHasLetters = false;
                
                for (let i = startRow; i < startRow + sampleSize && i < data.length; i++) {
                    const row = data[i];
                    if (row && row.length >= 2) {
                        const cellA = row[0] ? row[0].toString() : '';
                        const cellB = row[1] ? row[1].toString() : '';
                        
                        if (/[a-zA-Z]/.test(cellA)) colAHasLetters = true;
                        if (/[a-zA-Z]/.test(cellB)) colBHasLetters = true;
                    }
                }
                
                // 根据规则确定列类型
                if (colAHasLetters && !colBHasLetters) {
                    waterCardCol = 0;
                    serialCol = 1;
                } else if (colBHasLetters && !colAHasLetters) {
                    waterCardCol = 1;
                    serialCol = 0;
                } else if (colAHasLetters && colBHasLetters) {
                    // 两列都有字母，默认A列为水卡号
                    waterCardCol = 0;
                    serialCol = 1;
                } else {
                    // 都是纯数字，默认A列为流水号，B列为水卡号
                    serialCol = 0;
                    waterCardCol = 1;
                }
                
                // 提取数据
                const waterCards = [];
                const serials = [];
                
                for (let i = startRow; i < data.length; i++) {
                    const row = data[i];
                    if (row && row.length >= 2) {
                        if (waterCardCol >= 0 && row[waterCardCol]) {
                            waterCards.push(row[waterCardCol].toString());
                        }
                        if (serialCol >= 0 && row[serialCol]) {
                            serials.push(row[serialCol].toString());
                        }
                    }
                }
                
                parsedData = {
                    waterCardNumbers: waterCards,
                    serialNumbers: serials
                };
                
                // 显示预览
                let preview = `<h4>数据解析结果：</h4>`;
                preview += `<p>开始行：第${startRow + 1}行</p>`;
                preview += `<p>水卡号列：${String.fromCharCode(65 + waterCardCol)}列 (${waterCards.length}条)</p>`;
                preview += `<p>流水号列：${String.fromCharCode(65 + serialCol)}列 (${serials.length}条)</p>`;
                
                preview += `<table class="data-table">`;
                preview += `<tr><th>序号</th><th>水卡号</th><th>流水号</th></tr>`;
                
                const maxRows = Math.min(10, Math.max(waterCards.length, serials.length));
                for (let i = 0; i < maxRows; i++) {
                    preview += `<tr>`;
                    preview += `<td>${i + 1}</td>`;
                    preview += `<td>${waterCards[i] || ''}</td>`;
                    preview += `<td>${serials[i] || ''}</td>`;
                    preview += `</tr>`;
                }
                
                if (Math.max(waterCards.length, serials.length) > 10) {
                    preview += `<tr><td colspan="3">... 还有 ${Math.max(waterCards.length, serials.length) - 10} 行数据</td></tr>`;
                }
                
                preview += `</table>`;
                
                previewDiv.innerHTML = preview;
                statusDiv.innerHTML = `数据解析完成！共识别到 ${waterCards.length} 个水卡号和 ${serials.length} 个流水号`;
                
                // 更新按钮状态
                updateProcessButton();
                
            } catch (error) {
                statusDiv.innerHTML = `数据分析失败: ${error.message}`;
                previewDiv.innerHTML = '数据分析失败';
            }
        }
        
        // 处理Excel文件
        async function processExcelFile() {
            const statusDiv = document.getElementById('excelProcessStatus');
            const templateName = document.getElementById('templateSelect').value;
            
            if (!excelData || !templateName) {
                statusDiv.innerHTML = '请确保已上传文件并选择模板';
                return;
            }
            
            if (!loadedTemplates.has(templateName)) {
                statusDiv.innerHTML = '选中的模板文件不存在，请重新加载模板';
                return;
            }
            
            try {
                statusDiv.innerHTML = '🔄 正在使用模板处理数据...';
                
                // 获取模板工作簿和来源信息
                const templateInfo = loadedTemplates.get(templateName);
                const templateWorkbook = templateInfo.workbook;
                const templateSource = templateInfo.source || '本地缓存';
                
                // 使用模板处理数据
                const result = await processWithTemplate(templateWorkbook, templateName, templateSource);
                
                if (result.success) {
                    statusDiv.innerHTML = `✅ 文件处理完成！<br>` +
                        `• 使用模板：${templateName}<br>` +
                        `• 模板来源：${templateSource}<br>` +
                        `• 已下载文件：${result.filename}<br>` +
                        `• 水卡号：${parsedData.waterCardNumbers.length}条，流水号：${parsedData.serialNumbers.length}条<br>` +
                        `• 数据已填入模板A列和B列（从A2、B2开始）`;
                } else {
                    statusDiv.innerHTML = `❌ 处理失败：${result.error}`;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `❌ 处理失败: ${error.message}`;
                console.error('处理Excel文件失败:', error);
            }
        }
        
        // 使用模板处理数据
        async function processWithTemplate(templateWorkbook, templateName, templateSource) {
            try {
                // 克隆模板工作簿
                const newWorkbook = XLSX.utils.book_new();
                
                // 复制模板的所有工作表
                templateWorkbook.SheetNames.forEach(sheetName => {
                    const originalSheet = templateWorkbook.Sheets[sheetName];
                    
                    // 复制原工作表的数据
                    const sheetData = XLSX.utils.sheet_to_json(originalSheet, { header: 1, defval: '' });
                    
                    // 在A2和B2位置开始填入数据
                    const maxRows = Math.max(parsedData.waterCardNumbers.length, parsedData.serialNumbers.length);
                    
                    // 确保有足够的行数
                    while (sheetData.length < maxRows + 1) {
                        sheetData.push([]);
                    }
                    
                    // 填入数据到A列和B列（从A2、B2开始）
                    for (let i = 0; i < maxRows; i++) {
                        const rowIndex = i + 1; // 从第2行开始（0-based索引）
                        
                        // 确保行存在
                        if (!sheetData[rowIndex]) {
                            sheetData[rowIndex] = [];
                        }
                        
                        // 填入A列（水卡号）
                        if (parsedData.waterCardNumbers[i]) {
                            sheetData[rowIndex][0] = parsedData.waterCardNumbers[i];
                        }
                        
                        // 填入B列（流水号）
                        if (parsedData.serialNumbers[i]) {
                            sheetData[rowIndex][1] = parsedData.serialNumbers[i];
                        }
                    }
                    
                    // 创建新的工作表
                    const newSheet = XLSX.utils.aoa_to_sheet(sheetData);
                    
                    // 复制原始工作表的其他属性（如列宽、格式等）
                    if (originalSheet['!cols']) {
                        newSheet['!cols'] = originalSheet['!cols'];
                    }
                    if (originalSheet['!rows']) {
                        newSheet['!rows'] = originalSheet['!rows'];
                    }
                    if (originalSheet['!merges']) {
                        newSheet['!merges'] = originalSheet['!merges'];
                    }
                    
                    XLSX.utils.book_append_sheet(newWorkbook, newSheet, sheetName);
                });
                
                // 生成文件并下载
                const originalName = uploadedFileName;
                const extension = originalName.lastIndexOf('.') >= 0 ? originalName.slice(originalName.lastIndexOf('.')) : '.xlsx';
                const baseName = originalName.lastIndexOf('.') >= 0 ? originalName.slice(0, originalName.lastIndexOf('.')) : originalName;
                const filename = `${baseName}_已处理${extension}`;
                XLSX.writeFile(newWorkbook, filename);
                
                return {
                    success: true,
                    filename: filename,
                    templateSource: templateSource
                };
                
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // 使用默认模板处理
        function processWithDefaultTemplate() {
            const statusDiv = document.getElementById('excelProcessStatus');
            
            try {
                // 创建新的工作簿
                const newWorkbook = XLSX.utils.book_new();
                
                // 创建工作表数据
                const wsData = [];
                
                // 添加标题行
                wsData.push(['水卡号', '流水号']);
                
                // 添加数据行
                const maxRows = Math.max(parsedData.waterCardNumbers.length, parsedData.serialNumbers.length);
                for (let i = 0; i < maxRows; i++) {
                    wsData.push([
                        parsedData.waterCardNumbers[i] || '',
                        parsedData.serialNumbers[i] || ''
                    ]);
                }
                
                // 创建工作表
                const worksheet = XLSX.utils.aoa_to_sheet(wsData);
                
                // 添加工作表到工作簿
                XLSX.utils.book_append_sheet(newWorkbook, worksheet, 'Sheet1');
                
                // 生成文件并下载
                const originalName = uploadedFileName;
                const extension = originalName.lastIndexOf('.') >= 0 ? originalName.slice(originalName.lastIndexOf('.')) : '.xlsx';
                const baseName = originalName.lastIndexOf('.') >= 0 ? originalName.slice(0, originalName.lastIndexOf('.')) : originalName;
                const filename = `${baseName}已处理${extension}`;
                XLSX.writeFile(newWorkbook, filename);
                
                statusDiv.innerHTML = `文件处理完成！<br>` +
                    `• 使用默认模板<br>` +
                    `• 已下载文件：${filename}<br>` +
                    `• 水卡号：${parsedData.waterCardNumbers.length}条，流水号：${parsedData.serialNumbers.length}条`;
                
            } catch (error) {
                statusDiv.innerHTML = `默认模板处理失败: ${error.message}`;
            }
        }
        
        // 清空数据
        function clearExcelData() {
            excelData = null;
            parsedData = { waterCardNumbers: [], serialNumbers: [] };
            uploadedFileName = '';
            templateWorkbook = null;
            document.getElementById('excelFileInput').value = '';
            document.getElementById('templateSelect').value = '';
            document.getElementById('templateFileInput').value = '';
            
            // 移除上传的模板选项
            const select = document.getElementById('templateSelect');
            const uploadedOption = select.querySelector('option[value="uploaded"]');
            if (uploadedOption) {
                uploadedOption.remove();
            }
            
            document.getElementById('excelProcessStatus').innerHTML = '请上传Excel文件并选择模板';
            document.getElementById('excelDataPreview').innerHTML = '等待文件上传...';
            updateProcessButton();
        }
        
        // 更新处理按钮状态
        function updateProcessButton() {
            const hasFile = excelData !== null;
            const hasTemplate = document.getElementById('templateSelect').value !== '' && loadedTemplates.has('ic卡入库模板.xls');
            const processButton = document.querySelector('#excelTemplateTool .btn-primary');
            processButton.disabled = !(hasFile && hasTemplate);
            
            // 更新按钮文本显示当前状态
            if (processButton.disabled) {
                if (!hasFile) {
                    processButton.textContent = '📊 请先上传Excel文件';
                } else if (!hasTemplate) {
                    processButton.textContent = '📊 正在加载模板...';
                }
            } else {
                processButton.textContent = '📊 处理Excel文件';
            }
        }

        // 十进制转十六进制函数
        function convertDecToHex() {
            const decimalValue = document.getElementById('decimalInput').value;
            if (/^\d+$/.test(decimalValue)) {
                const hex = parseInt(decimalValue).toString(16).toUpperCase();
                document.getElementById('hexInput').value = hex;
            } else {
                document.getElementById('hexInput').value = '';
            }
        }

        // 十六进制转十进制函数
        function convertHexToDec() {
            const hexValue = document.getElementById('hexInput').value;
            if (/^[0-9A-Fa-f]+$/.test(hexValue)) {
                const decimal = parseInt(hexValue, 16);
                document.getElementById('decimalInput').value = decimal;
            } else {
                document.getElementById('decimalInput').value = '';
            }
        }

        // 脉冲计算主函数
        function calculateActualPulses() {
            const systemPulses = parseFloat(document.getElementById('systemPulses').value);
            const systemWater = parseFloat(document.getElementById('systemWater').value);
            const actualWater = parseFloat(document.getElementById('actualWater').value);
            
            if (systemPulses > 0 && systemWater > 0 && actualWater > 0) {
                const actualPulses = (systemPulses * systemWater) / actualWater;
                document.getElementById('actualPulses').value = actualPulses.toFixed(2);
            } else {
                document.getElementById('actualPulses').value = '';
            }
        }


        // 参数解析函数（简化版本）
        function parseParams() {
            const inputText = document.getElementById('paramInput').value;
            
            // 新增公司名称匹配规则
            const companyMatch = inputText.match(/^([\s\S]*?)\s*跃龙/);
            let processedText = inputText;
            const rawItems = [];
            const formattedItems = [];
        
            // 提取公司名称
            if (companyMatch) {
                const company = companyMatch[1].trim().replace(/\s+/g, ' ');
                rawItems.push(`公司=${company}`);
                formattedItems.push(`公司：${company}`);  // 保持黑色
                processedText = processedText.replace(companyMatch[0], '');
            }
        
            // 优化跃龙类型判断逻辑（在第214-223行）
            const yuelongTypes = [
                { pattern: '跃龙新私有', value: '新私有' },
                { pattern: '跃龙公有售水机', value: '公有售水机' },
                { pattern: '跃龙新公有', value: '新公有' },
                { pattern: '跃龙公有', value: '公有' },
                { pattern: '跃龙私有', value: '私有' }
            ];
            
            // 修改为使用原始输入文本判断
            yuelongTypes.forEach(type => {
                if (inputText.includes(type.pattern)) {
                    rawItems.push(`跃龙类型=${type.value}`);
                    formattedItems.push(`跃龙类型：${type.value}`);  // 保持黑色
                }
            });

            // 优化ICCID匹配（第225-231行）
            const iccidMatches = [...processedText.matchAll(/(89860[\dA-Za-z]{14,18})/g)];
            const iccids = iccidMatches.map(m => m[0]);
            
            // 只处理第一个ICCID
            if (iccids.length > 0) {
                rawItems.push(`ICCID开始=${iccids[0]}`);
                formattedItems.push(`ICCID开始：${iccids[0]}`);  // 保持黑色
            }
            // 移除所有ICCID
            iccids.forEach(iccid => {
                processedText = processedText.replace(iccid, '');
            });

            // 优化后的数量提取规则（支持中文符号间隔）
            const quantityMatch = processedText.match(/(\d+)\s*张(?=\D*$)/);
            if (quantityMatch) {
                rawItems.push(`数量=${quantityMatch[1]}`);
                formattedItems.push(`数量：${quantityMatch[1]}`);
                processedText = processedText.replace(quantityMatch[0], '');
            }
        
            // 新增预处理：过滤"其中"相关内容
            processedText = processedText.replace(/其中\D*(\d+)[\u4e00-\u9fa5]+/g, '');
        
            // 新增滤芯寿命类型判断
            let filterType = '空';
            if (/时间/.test(processedText)) {
                filterType = '0时间';
            } else if (/流量/.test(processedText)) {
                filterType = '1流量';
            }
            rawItems.push(`滤芯寿命类型=${filterType}`);
            formattedItems.push(`滤芯寿命类型：${filterType}`);

            // 优化后的参数解析逻辑（兼容路径和普通参数）
            const pattern = /((?:[\u4e00-\u9fa5]+(?:\/[\u4e00-\u9fa5\/\[\]]+)*|[\u4e00-\u9fa5]+))(\d+\.?\d*)/g;
            const matches = [...processedText.matchAll(pattern)];
            
            matches.forEach(match => {
                let title = match[1]
                    .replace(/\[.*?\]/g, '')  // 移除单位说明
                    .replace(/\/+/g, '/')     // 合并连续斜杠
                    .replace(/\/$/, '');     // 去除结尾斜杠
                const value = match[2];
        
                // 新增中文参数名称过滤
                if(title && value && !/^[\u4e00-\u9fa5]+$/.test(value)) {
                    rawItems.push(`${title}=${value}`);
                    formattedItems.push(`${title}：${value}`);
                }
            });
        
            // 显示结果
            // 注释掉原始参数显示
            // document.getElementById('rawParams').innerHTML = rawItems.join('<br>');
            
            // 格式化显示结果，特殊项保持黑色，其他项值显示为红色
            const formattedHTML = formattedItems.map(item => {
                const [key, value] = item.split('：');
                if (key === '公司' || key === '跃龙类型' || key === 'ICCID开始') {
                    return item;  // 保持原样
                }
                return `${key}：<span style="color:red">${value}</span>`;
            }).join('<br>');
            
            document.getElementById('formattedParams').innerHTML = formattedHTML;
        }

        // ICCID解析函数
        function parseIccids() {
            const inputText = document.getElementById('iccidInput').value;
            const resultArray = [];
            
            // 处理范围格式：ICCID到ICCID(数量张)
            const rangePattern = /(\d+[A-Za-z0-9]+)到(\d+[A-Za-z0-9]+)(?:\s*[\(（](\d+)张[\)）])?/g;
            let match;
            
            // 处理范围格式
            while ((match = rangePattern.exec(inputText)) !== null) {
                const startIccid = match[1];
                const endIccid = match[2];
                const count = match[3] ? parseInt(match[3]) : null;
                
                // 提取数字部分
                const numericStart = extractNumericSuffix(startIccid);
                const numericEnd = extractNumericSuffix(endIccid);
                
                if (numericStart && numericEnd) {
                    const prefix = startIccid.substring(0, startIccid.length - numericStart.length);
                    const startNum = parseInt(numericStart);
                    const endNum = parseInt(numericEnd);
                    
                    // 验证范围是否与指定数量匹配
                    const actualCount = endNum - startNum + 1;
                    if (count !== null && actualCount !== count) {
                        console.warn(`警告：指定数量 ${count} 与实际范围 ${actualCount} 不匹配`);
                    }
                    
                    // 生成范围内的所有ICCID
                    for (let i = startNum; i <= endNum; i++) {
                        const paddedNum = i.toString().padStart(numericStart.length, '0');
                        resultArray.push(prefix + paddedNum);
                    }
                } else {
                    console.error('无法提取数字部分:', startIccid, endIccid);
                }
            }
            
            // 同时处理单行ICCID格式（无论是否已处理范围格式）
            // 分割输入文本，处理每一行
            const lines = inputText.split(/[\n\r]+/);
            
            lines.forEach(line => {
                // 跳过包含"到"的行，因为这些行已经在范围处理中处理过了
                if (line.includes('到')) {
                    return;
                }
                
                // 清理每行，移除可能的引号和空格
                const cleanedLine = line.trim().replace(/['""`]/g, '');
                
                // 如果是有效的ICCID（至少包含数字和可能的字母，长度大于10）
                if (/^\d+[A-Za-z0-9]*$/.test(cleanedLine) && cleanedLine.length > 10) {
                    resultArray.push(cleanedLine);
                }
            });
            
            // 显示结果，每行一个ICCID
            document.getElementById('iccidResult').value = resultArray.join('\n');
        }
        
        // 提取ICCID末尾的数字部分
        function extractNumericSuffix(iccid) {
            const match = iccid.match(/(\d+)$/);
            return match ? match[1] : null;
        }
        
        // 修改ICCID格式函数
        function formatIccids() {
            const resultText = document.getElementById('iccidResult').value;
            if (!resultText.trim()) {
                alert('请先解析ICCID数据');
                return;
            }
            
            // 将换行分隔的ICCID转换为逗号分隔
            const iccids = resultText.split('\n').filter(line => line.trim());
            document.getElementById('iccidResult').value = iccids.join(',');
        }
        
        // 恢复ICCID格式函数 - 在每个ICCID后添加单引号
        function addQuotesToIccids() {
            const resultText = document.getElementById('iccidResult').value;
            if (!resultText.trim()) {
                alert('请先解析ICCID数据');
                return;
            }
            
            // 处理不同格式的ICCID
            let iccids;
            if (resultText.includes(',')) {
                // 逗号分隔的格式
                iccids = resultText.split(',').filter(item => item.trim());
                // 添加单引号并重新用逗号连接
                document.getElementById('iccidResult').value = iccids.map(iccid => 
                    iccid.trim().endsWith("'") ? iccid.trim() : iccid.trim() + "'"
                ).join(',');
            } else {
                // 换行分隔的格式
                iccids = resultText.split('\n').filter(line => line.trim());
                // 添加单引号并保持换行格式
                document.getElementById('iccidResult').value = iccids.map(iccid => 
                    iccid.trim().endsWith("'") ? iccid.trim() : iccid.trim() + "'"
                ).join('\n');
            }
        }

        // 金额水量换算函数
        function calculateWaterValue() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const waterVolume = parseFloat(document.getElementById('waterVolume').value) || 0;
            const mlPerCent = parseFloat(document.getElementById('pricePerMl').value) || 0;
            
            let results = [];
            
            if (amount > 0 && waterVolume > 0) {
                const calculatedMlPerCent = waterVolume / (amount * 100);
                document.getElementById('pricePerMl').value = calculatedMlPerCent.toFixed(4);
                results.push(`🧮 1分钱对应：<span style="color:red">${calculatedMlPerCent.toFixed(4)}毫升</span>`);
                results.push(`💧 ${waterVolume}毫升 = <span style="color:red">${amount}元</span>`);
            } else if (amount > 0 && mlPerCent > 0) {
                const calculatedVolume = (amount * 100) * mlPerCent;
                document.getElementById('waterVolume').value = calculatedVolume.toFixed(2);
                results.push(`💧 水量：<span style="color:red">${calculatedVolume.toFixed(2)}毫升</span>`);
            } else if (waterVolume > 0 && mlPerCent > 0) {
                const calculatedAmount = waterVolume / mlPerCent / 100;
                document.getElementById('amount').value = calculatedAmount.toFixed(2);
                results.push(`💰 金额：<span style="color:red">${calculatedAmount.toFixed(2)}元</span>`);
            } else {
                results.push(`📝 请输入任意两个参数进行计算`);
            }
            
            document.getElementById('waterCalculations').innerHTML = results.join('<br>');
        }

        // 水单价计算函数
        function calculateWaterPrice() {
            const waterVolume = parseFloat(document.getElementById('waterVolume2').value) || 0;
            const amount = parseFloat(document.getElementById('amount2').value) || 0;
            const pricePerLiter = parseFloat(document.getElementById('pricePerLiter').value) || 0;
            
            let results = [];
            
            if (waterVolume > 0 && amount > 0) {
                const calculatedPricePerLiter = (amount / waterVolume) * 1000;
                document.getElementById('pricePerLiter').value = calculatedPricePerLiter.toFixed(4);
                results.push(`🚰 <strong>计算结果：1升水单价 = <span style="color:red;font-size:18px">${calculatedPricePerLiter.toFixed(4)}元/升</span></strong>`);
                results.push(`📊 计算过程：${amount}元 ÷ ${waterVolume}毫升 × 1000 = ${calculatedPricePerLiter.toFixed(4)}元/升`);
            } else if (waterVolume > 0 && pricePerLiter > 0) {
                const calculatedAmount = (waterVolume / 1000) * pricePerLiter;
                document.getElementById('amount2').value = calculatedAmount.toFixed(4);
                results.push(`💰 <strong>应付金额：<span style="color:red;font-size:18px">${calculatedAmount.toFixed(4)}元</span></strong>`);
            } else if (amount > 0 && pricePerLiter > 0) {
                const calculatedVolume = (amount / pricePerLiter) * 1000;
                document.getElementById('waterVolume2').value = calculatedVolume.toFixed(2);
                results.push(`💧 <strong>可购买水量：<span style="color:red;font-size:18px">${calculatedVolume.toFixed(2)}毫升</span></strong>`);
            } else {
                results.push(`📝 请输入任意两个参数进行计算`);
                results.push(`💡 示例：输入787毫升和0.2385元，自动计算1升水单价`);
            }
            
            document.getElementById('waterPriceCalculations').innerHTML = results.join('<br>');
        }

        // CSV/Excel文件处理相关
        document.getElementById('csvFileInput').addEventListener('change', function() {
            const processButton = document.querySelector('#csv89860Tool button');
            if (this.files.length > 0) {
                processButton.disabled = false;
                document.getElementById('csvProcessStatus').textContent = `已选择文件: ${this.files[0].name}`;
            } else {
                processButton.disabled = true;
                document.getElementById('csvProcessStatus').textContent = '请选择文件进行处理';
            }
        });
        
        function processCSVFile() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('csvProcessStatus').textContent = '请先选择文件';
                return;
            }
            
            document.getElementById('csvProcessStatus').textContent = '正在处理文件...';
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            // 根据文件类型选择处理方法
            if (fileExtension === 'csv') {
                processCSV(file);
            } else if (['xls', 'xlsx'].includes(fileExtension)) {
                processExcel(file);
            } else {
                document.getElementById('csvProcessStatus').textContent = '不支持的文件格式，请选择CSV、XLS或XLSX文件';
            }
        }
        
        // 处理CSV文件
        function processCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let matchCount = 0;
                    
                    // 处理引号中的89860开头的值
                    let modifiedContent = content;
                    const pattern89860 = /"89860/g;
                    const matches89860 = content.match(pattern89860) || [];
                    modifiedContent = modifiedContent.replace(pattern89860, '"\'89860');
                    matchCount += matches89860.length;
                    
                    // 处理86开头的15位数字(IMEI)
                    // 先匹配引号中的IMEI
                    const patternIMEIQuoted = /"86\d{13}"/g;
                    const matchesIMEIQuoted = content.match(patternIMEIQuoted) || [];
                    modifiedContent = modifiedContent.replace(patternIMEIQuoted, (match) => {
                        return `"'${match.substring(1, match.length - 1)}"`;
                    });
                    matchCount += matchesIMEIQuoted.length;

                    // 再匹配没有引号的IMEI（通常在CSV中出现）
                    const patternIMEIUnquoted = /(^|,|\n)86\d{13}($|,|\n)/g;
                    const matchesIMEIUnquoted = content.match(patternIMEIUnquoted) || [];
                    modifiedContent = modifiedContent.replace(patternIMEIUnquoted, (match) => {
                        // 保留分隔符
                        if (match.startsWith(',') || match.startsWith('\n')) {
                            const prefix = match[0];
                            const imei = match.substring(1, match.length - 1);
                            const suffix = match[match.length - 1];
                            return `${prefix}"${imei}"${suffix}`;
                        } else if (match.endsWith(',') || match.endsWith('\n')) {
                            const prefix = match[0];
                            const imei = match.substring(1, match.length - 1);
                            const suffix = match[match.length - 1];
                            return `${prefix}"${imei}"${suffix}`;
                        } else {
                            const imei = match;
                            return `"${imei}"`;
                        }
                    });
                    matchCount += matchesIMEIUnquoted.length;
                    
                    // 处理可能被Excel转为科学计数法的长数字
                    // 匹配引号中的10位以上纯数字
                    const patternLongNum = /"\d{10,}"/g;
                    const matchesLongNum = content.match(patternLongNum) || [];
                    modifiedContent = modifiedContent.replace(patternLongNum, (match) => {
                        // 避免重复处理已经添加单引号的值
                        if (!match.includes("'")) {
                            return `"'${match.substring(1, match.length - 1)}"`;
                        }
                        return match;
                    });
                    matchCount += matchesLongNum.length;
                    
                    // 创建下载链接
                    const blob = new Blob(['\ufeff' + modifiedContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    // 设置下载文件名
                    const originalName = file.name;
                    const extension = originalName.lastIndexOf('.') >= 0 ? originalName.slice(originalName.lastIndexOf('.')) : '.csv';
                    const baseName = originalName.lastIndexOf('.') >= 0 ? originalName.slice(0, originalName.lastIndexOf('.')) : originalName;
                    const downloadName = `${baseName}_processed${extension}`;
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', downloadName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    document.getElementById('csvProcessStatus').textContent = `处理完成！共处理了 ${matchCount} 个需要添加单引号的值，文件已下载`;
                    
                    // 重置文件输入，允许再次选择同一文件
                    document.getElementById('csvFileInput').value = '';
                    document.querySelector('#csv89860Tool button').disabled = true;
                } catch (error) {
                    document.getElementById('csvProcessStatus').textContent = `处理失败: ${error.message}`;
                }
            };
            
            reader.onerror = function() {
                document.getElementById('csvProcessStatus').textContent = '读取文件失败';
            };
            
            // 读取文件内容
            reader.readAsText(file, 'utf-8');
        }
        
        // 处理Excel文件
        function processExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let totalProcessedCount = 0;
                    
                    // 处理每个工作表
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1:A1');
                        
                        let sheetProcessedCount = 0;
                        
                        // 遍历所有单元格
                        for (let row = range.s.r; row <= range.e.r; row++) {
                            for (let col = range.s.c; col <= range.e.c; col++) {
                                const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                                const cell = worksheet[cellAddress];
                                
                                if (cell && cell.v && typeof cell.v === 'string') {
                                    const originalValue = cell.v;
                                    let modified = false;
                                    
                                    // 检查是否需要添加单引号
                                    // 去除前后空格后再判断
                                    const trimmedValue = originalValue.trim();
                                    if (
                                        (trimmedValue.startsWith('89860') || 
                                        (trimmedValue.startsWith('86') && /^86\d{13}$/.test(trimmedValue)) ||
                                        /^\d{10,}$/.test(trimmedValue)) &&
                                        !originalValue.startsWith("'")
                                    ) {
                                        // 在值前添加单引号，并设置单元格类型为文本
                                        cell.v = `'${originalValue}`;
                                        cell.t = 's'; // 设置为字符串类型
                                        modified = true;
                                        sheetProcessedCount++;
                                    }
                                } else if (cell && typeof cell.v === 'number') {
                                    // 处理数字类型值
                                    const originalValue = cell.v.toString();
                                    
                                    // 检查是否是长数字（可能被Excel转为科学计数法）
                                    if (originalValue.length >= 10 && !originalValue.includes('.')) {
                                        // 转换为字符串并添加单引号
                                        cell.v = `'${originalValue}`;
                                        cell.t = 's'; // 设置为字符串类型
                                        modified = true;
                                        sheetProcessedCount++;
                                    }
                                }
                            }
                        }
                        
                        totalProcessedCount += sheetProcessedCount;
                        console.log(`工作表 ${sheetName} 处理了 ${sheetProcessedCount} 个单元格`);
                    });
                    
                    // 生成处理后的文件
                    const originalName = file.name;
                    const extension = originalName.lastIndexOf('.') >= 0 ? originalName.slice(originalName.lastIndexOf('.')) : '.xlsx';
                    const baseName = originalName.lastIndexOf('.') >= 0 ? originalName.slice(0, originalName.lastIndexOf('.')) : originalName;
                    const downloadName = `${baseName}_processed${extension}`;
                    
                    // 下载文件
                    XLSX.writeFile(workbook, downloadName);
                    
                    document.getElementById('csvProcessStatus').textContent = `处理完成！共处理了 ${totalProcessedCount} 个单元格，文件已下载`;
                    
                    // 重置文件输入，允许再次选择同一文件
                    document.getElementById('csvFileInput').value = '';
                    document.querySelector('#csv89860Tool button').disabled = true;
                } catch (error) {
                    document.getElementById('csvProcessStatus').textContent = `处理失败: ${error.message}`;
                    console.error('Excel处理错误:', error);
                }
            };
            
            reader.onerror = function() {
                document.getElementById('csvProcessStatus').textContent = '读取文件失败';
            };
            
            // 读取文件内容
            reader.readAsArrayBuffer(file);
        }
        
        // 十进制转十六进制函数
        function convertDecToHex() {
            const decimalValue = document.getElementById('decimalInput').value;
            // 正则验证十进制格式
            if (/^\d+$/.test(decimalValue)) {
                const hex = parseInt(decimalValue)
                          .toString(16)
                          .toUpperCase();
                document.getElementById('hexInput').value = hex;
            } else {
                document.getElementById('hexInput').value = '';
            }
        }
        
        // 十六进制转十进制函数
        function convertHexToDec() {
            const hexValue = document.getElementById('hexInput').value;
            // 正则验证十六进制格式（不区分大小写）
            if (/^[0-9A-Fa-f]+$/.test(hexValue)) {
                const decimal = parseInt(hexValue, 16);
                document.getElementById('decimalInput').value = decimal;
            } else {
                document.getElementById('decimalInput').value = '';
            }
        }
        
        // 事件绑定
        document.addEventListener('DOMContentLoaded', function() {
            // 脉冲计算器事件
            document.getElementById('systemPulses').addEventListener('input', calculateActualPulses);
            document.getElementById('systemWater').addEventListener('input', calculateActualPulses);
            document.getElementById('actualWater').addEventListener('input', calculateActualPulses);
            
            // 进制转换事件
            document.getElementById('decimalInput').addEventListener('input', convertDecToHex);
            document.getElementById('hexInput').addEventListener('input', convertHexToDec);
        
            // 参数解析器回车事件
            document.getElementById('paramInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    parseParams();
                    this.blur();
                }
            });

            
            // Excel文件上传事件
            const fileInput = document.getElementById('excelFileInput');
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    readExcelFile(file);
                } else {
                    clearExcelData();
                }
            });
            
            // 模板选择事件
            document.getElementById('templateSelect').addEventListener('change', function(e) {
                if (e.target.value === 'upload') {
                    // 触发模板文件上传
                    document.getElementById('templateFileInput').click();
                    // 重置选择框
                    e.target.value = '';
                } else {
                    updateProcessButton();
                }
            });
            
            // 初始化：加载远程模板
            loadRemoteTemplate().then(() => {
                console.log('远程模板初始化完成');
                // 确保按钮状态正确更新
                updateProcessButton();
            }).catch(error => {
                console.error('远程模板初始化失败:', error);
                // 即使加载失败也要更新按钮状态
                updateProcessButton();
            });

            // 默认显示IC卡号处理工具
            showTool('pulseTool');
        });
    </script>

    <!-- 二维码生成器工具模块 -->
    <section id="qrGeneratorTool" class="calculator" style="display: none;">
        <h2>🔲 二维码批量生成器</h2>
        
        <div class="info-box">
            <strong>📋 功能说明：</strong><br>
            1. 使用稳定的二维码API，无跨域限制<br>
            2. 自动在二维码下方添加IMEI文字，文字大小自适应二维码宽度<br>
            3. 输出为360x360px正方形PNG图片，便于打印和使用<br>
            4. 支持批量生成和ZIP打包下载，稳定可靠
        </div>
        
        <div class="form-group">
            <label for="qrPrefix">二维码前缀：</label>
            <input type="text" id="qrPrefix" placeholder="例：http://cloud.yuelongxinxi.com/qr/" value="http://cloud.yuelongxinxi.com/qr/">
        </div>
        
        <div class="form-group">
            <label for="qrImeiList">IMEI列表（一行一个）：</label>
            <textarea id="qrImeiList" placeholder="请输入IMEI，一行一个，例如：&#10;860256072911545&#10;860256072911546&#10;860256072911547"></textarea>
        </div>
        
        <div class="button-group">
            <button class="btn btn-primary" id="qrGenerateBtn">
                <span id="qrGenerateBtnText">🔲 生成二维码</span>
                <span id="qrGenerateBtnLoading" class="loading" style="display: none;"></span>
            </button>
            <button class="btn btn-success" id="qrDownloadBtn" disabled>
                📦 打包下载 (PNG格式)
            </button>
        </div>
        
        <div class="api-status" id="qrApiStatus">
            <span class="api-icon">📡</span>
            <span id="qrApiStatusText">准备生成二维码...</span>
        </div>
        
        <div class="progress-container" id="qrProgressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="qrProgressFill"></div>
            </div>
            <div class="progress-text" id="qrProgressText">准备生成...</div>
        </div>
        
        <div class="error-message" id="qrErrorMessage"></div>
        <div class="success-message" id="qrSuccessMessage"></div>
        
        <div class="qr-grid" id="qrGrid"></div>
    </section>
    <!-- 日志分析器工具模块 -->
        <section id="logAnalysisTool" class="calculator" style="display: none;">
            <h2>📊 日志分析器</h2>
        
        <div class="log-analysis-tool">
            <div class="log-input-section">
                <textarea id="logInput" placeholder="请粘贴原始日志数据，每行一条数据...

支持的数据格式：
• 类型1: 0000011800800100000000001e012c000a000000000002009700000000000000000153588000000000025000000000a80100026a
• 类型2: 000035F1 00-80-00 0001 0BB8-000F 0258-0003 004B-0000 0000-0000 0000-2DDD-0000-0324-0332 0000-0000-0000-0000-0001 0000C03C 00 0584
• 类型3: 0000000C01440600000000000000000000012CD4C0000001E000000000000000000D0A000000010014070800000001000000141F1F000D030397
• 类型4: 00003B13 05-0C-09 0000 00000000-0000 00000000-0000 00005B1B-0146 0000-0000 0000-0000-4125-0000-0000 4E20-4E20-9C40-4E20-4E20 1C1DCF2A 03 0554

支持功能：
1. 自动识别多种数据类型并应用相应的解析规则
2. 格式灵活：支持带或不带"-"分隔符的数据格式
3. 表格展示：使用表格清晰展示每个字段的值和位置
4. 统计信息：显示解析成功和失败的条目数
5. 快捷键：按Ctrl+Enter可快速分析数据

数据字段说明：
• 设备ID、计费模式、命令、设备状态
• 本次消费、充值流量、充值天数、剩余流量、剩余天数
• 已用流量、已用天数、纯水TDS、原水TDS
• 各级滤芯寿命、最大滤芯寿命
• 北京时间、机器类型、校验码

使用提示：
- 每行输入一条数据，可批量解析多条日志
- 工具会自动清理数据中的空格和分隔符
- 表格支持水平滚动查看完整数据
- 悬停在表格单元格上可查看详细信息
- 解析错误时会显示具体错误原因和原始数据
- 支持多种日志格式的自动识别与解析

输入示例：
0000011800800100000000001e012c000a000000000002009700000000000000000153588000000000025000000000a80100026a
000035F1 00-80-00 0001 0BB8-000F 0258-0003 004B-0000 0000-0000 0000-2DDD-0000-0324-0332 0000-0000-0000-0000-0001 0000C03C 00 0584
0000000C01440600000000000000000000012CD4C0000001E000000000000000000D0A000000010014070800000001000000141F1F000D030397
00003B13 05-0C-09 0000 00000000-0000 00000000-0000 00005B1B-0146 0000-0000 0000-0000-4125-0000-0000 4E20-4E20-9C40-4E20-4E20 1C1DCF2A 03 0554

⚡ 按 Ctrl+Enter 快速分析数据 ⚡"></textarea>
                
                <div class="buttons-section">
                    <button id="analyzeBtn" class="analyze-btn">🚀 分析数据</button>
                    <button id="clearLogBtn" class="clear-btn">🗑️ 清空</button>
                </div>
            </div>
            
            <div id="statusSection" class="status-section"></div>
            
            <div class="result-section">
                <div class="result-content">
                    <!-- 解析结果将在这里动态生成 -->
                </div>
            </div>
        </div>
    </section>
       <section id="logAnalysisTool2" class="calculator" style="display: none;">
        <h2>📊 日志解析器</h2>
        
        <div class="log-analysis-tool">
            <div class="log-input-section">
                <textarea id="logInput2" placeholder="请粘贴原始日志数据，每行一条数据...

⚡ 按 Ctrl+Enter 快速分析数据 ⚡"></textarea>
                
                <div class="buttons-section">
                    <button id="analyzeBtn2" class="analyze-btn" onclick="analysis2()">🚀 分析数据</button>
                    <button id="clearLogBtn" class="clear-btn">🗑️ 清空</button>
                </div>
            </div>
            
            <div id="statusSection" class="status-section"></div>
            
            <div class="result-section">
                <div class="result-content">
                    <!-- 解析结果将在这里动态生成 -->
                </div>
            </div>
        </div>
    </section>
    <script>
        // 全局定义analysis2函数，确保按钮点击时可以访问
        function analysis2() {
            // 获取最新的输入值
            const rawInput2 = document.getElementById('logInput2').value.trim();
            
            // 检查输入是否为空
            if (!rawInput2) {
                alert('请输入日志数据！');
                return;
            }
            
            try {
                // 调用logDecode.js中的analysis函数处理日志数据
                const result = analysis(rawInput2);
                
                // 获取结果显示区域
                const resultContent = document.querySelector('#logAnalysisTool2 .result-content');
                
                // 检查result是否存在并格式化显示结果
                if (result && typeof result === 'object') {
                    // 按照参数解析器的样式显示结果
                    let html = '<div class="param-results"><div class="param-group"><div class="param-column"><h4>解析结果：</h4>';
                    
                    // 遍历result对象的所有属性，只显示非空的value
                    for (const [key, value] of Object.entries(result)) {
                        // 检查value是否存在且不为空
                        if (value && value.trim() !== '') {
                            html += `<div>${value}</div>`;
                        }
                    }
                    
                    html += '</div></div></div>';
                    resultContent.innerHTML = html;
                } else if (typeof result === 'string') {
                    // 如果result是字符串，直接显示
                    resultContent.innerHTML = `<div class="param-results"><div class="param-group"><div class="param-column"><h4>解析结果：</h4><div>${result}</div></div></div></div>`;
                } else {
                    // 如果没有有效的结果，显示错误信息
                    resultContent.innerHTML = '<div class="error-message">无法解析日志数据，请检查输入格式。</div>';
                }
            } catch (error) {
                console.error('日志解析错误:', error);
                const resultContent = document.querySelector('#logAnalysisTool2 .result-content');
                resultContent.innerHTML = `<div class="error-message">解析出错：${error.message}</div>`;
            }
        }
        
        $(document).ready(function() {
            // 为日志解析器2添加快捷键支持（Ctrl+Enter）
            const logInput2Element = document.getElementById('logInput2');
            if (logInput2Element) {
                logInput2Element.addEventListener('keydown', function(event) {
                    if (event.ctrlKey && event.key === 'Enter') {
                        event.preventDefault();
                        analysis2();
                    }
                });
            }
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // ===== 日志解析功能 logDecode.js =====
        // 数据类型定义
        const dataTypes = {
            type1: {
                name: "数据类型1 (52字节)",
                fields: [
                    {name: "设备ID", start: 0, end: 3},
                    {name: "计费模式", start: 4, end: 4},
                    {name: "命令", start: 5, end: 5},
                    {name: "设备状态", start: 6, end: 6},
                    {name: "本次消费", start: 7, end: 8},
                    {name: "充值流量", start: 9, end: 10},
                    {name: "充值天数", start: 11, end: 12},
                    {name: "剩余流量", start: 13, end: 14},
                    {name: "剩余天数", start: 15, end: 16},
                    {name: "已用流量", start: 17, end: 18},
                    {name: "已用天数", start: 19, end: 20},
                    {name: "纯水TDS", start: 21, end: 22},
                    {name: "原水TDS", start: 23, end: 24},
                    {name: "1级", start: 25, end: 26},
                    {name: "2级", start: 27, end: 28},
                    {name: "3级", start: 29, end: 30},
                    {name: "4级", start: 31, end: 32},
                    {name: "5级", start: 33, end: 34},
                    {name: "大1", start: 35, end: 36},
                    {name: "大2", start: 37, end: 38},
                    {name: "大3", start: 39, end: 40},
                    {name: "大4", start: 41, end: 42},
                    {name: "大5", start: 43, end: 44},
                    {name: "北京时间", start: 45, end: 48},
                    {name: "机器类型", start: 49, end: 49},
                    {name: "校验码", start: 50, end: 51}
                ]
            },
            type2: {
                name: "数据类型2 (52字节)",
                fields: [
                    {name: "设备ID", start: 0, end: 3},
                    {name: "计费模式", start: 4, end: 4},
                    {name: "命令", start: 5, end: 5},
                    {name: "设备状态", start: 6, end: 6},
                    {name: "本次消费", start: 7, end: 8},
                    {name: "充值流量", start: 9, end: 10},
                    {name: "充值天数", start: 11, end: 12},
                    {name: "剩余流量", start: 13, end: 14},
                    {name: "剩余天数", start: 15, end: 16},
                    {name: "已用流量", start: 17, end: 18},
                    {name: "已用天数", start: 19, end: 20},
                    {name: "纯水TDS", start: 21, end: 22},
                    {name: "原水TDS", start: 23, end: 24},
                    {name: "1级", start: 25, end: 26},
                    {name: "2级", start: 27, end: 28},
                    {name: "3级", start: 29, end: 30},
                    {name: "4级", start: 31, end: 32},
                    {name: "5级", start: 33, end: 34},
                    {name: "大1", start: 35, end: 36},
                    {name: "大2", start: 37, end: 38},
                    {name: "大3", start: 39, end: 40},
                    {name: "大4", start: 41, end: 42},
                    {name: "大5", start: 43, end: 44},
                    {name: "北京时间", start: 45, end: 48},
                    {name: "机器类型", start: 49, end: 49},
                    {name: "校验码", start: 50, end: 51}
                ]
            },
            type3: {
                name: "数据类型3 (52字节)",
                fields: [
                    {name: "设备ID", start: 0, end: 3},
                    {name: "计费模式", start: 4, end: 4},
                    {name: "命令", start: 5, end: 5},
                    {name: "设备状态", start: 6, end: 6},
                    {name: "本次消费", start: 7, end: 8},
                    {name: "充值流量", start: 9, end: 12},
                    {name: "充值天数", start: 13, end: 14},
                    {name: "剩余流量", start: 15, end: 18},
                    {name: "剩余天数", start: 19, end: 20},
                    {name: "已用流量", start: 21, end: 24},
                    {name: "已用天数", start: 25, end: 26},
                    {name: "纯水TDS", start: 27, end: 28},
                    {name: "原水TDS", start: 29, end: 30},
                    {name: "1级", start: 31, end: 32},
                    {name: "2级", start: 33, end: 34},
                    {name: "3级", start: 35, end: 36},
                    {name: "4级", start: 37, end: 38},
                    {name: "5级", start: 39, end: 40},
                    {name: "大1", start: 41, end: 42},
                    {name: "大2", start: 43, end: 44},
                    {name: "大3", start: 45, end: 46},
                    {name: "大4", start: 47, end: 48},
                    {name: "大5", start: 49, end: 50},
                    {name: "北京时间", start: 51, end: 54},
                    {name: "机器类型", start: 55, end: 55},
                    {name: "校验码", start: 56, end: 57}
                ]
            },
            type4: {
                name: "数据类型4 (58字节)",
                fields: [
                    {name: "设备ID", start: 0, end: 3},
                    {name: "计费模式", start: 4, end: 4},
                    {name: "命令", start: 5, end: 5},
                    {name: "设备状态", start: 6, end: 6},
                    {name: "本次消费", start: 7, end: 8},
                    {name: "充值流量", start: 9, end: 12},
                    {name: "充值天数", start: 13, end: 14},
                    {name: "剩余流量", start: 15, end: 18},
                    {name: "剩余天数", start: 19, end: 20},
                    {name: "已用流量", start: 21, end: 24},
                    {name: "已用天数", start: 25, end: 26},
                    {name: "纯水TDS", start: 27, end: 28},
                    {name: "原水TDS", start: 29, end: 30},
                    {name: "1级", start: 31, end: 32},
                    {name: "2级", start: 33, end: 34},
                    {name: "3级", start: 35, end: 36},
                    {name: "4级", start: 37, end: 38},
                    {name: "5级", start: 39, end: 40},
                    {name: "大1", start: 41, end: 42},
                    {name: "大2", start: 43, end: 44},
                    {name: "大3", start: 45, end: 46},
                    {name: "大4", start: 47, end: 48},
                    {name: "大5", start: 49, end: 50},
                    {name: "北京时间", start: 51, end: 54},
                    {name: "机器类型", start: 55, end: 55},
                    {name: "校验码", start: 56, end: 57}
                ]
            }
        };

        // 清理十六进制数据
        function cleanHexData(data) {
            return data.replace(/[\s\-\r\n]/g, '').toUpperCase();
        }

        // 十六进制转十进制
        function hexToDec(hex) {
            return parseInt(hex, 16);
        }

        // 提取字节范围
        function extractBytes(data, start, end) {
            const startPos = start * 2;
            const endPos = (end + 1) * 2;
            const hex = data.substring(startPos, endPos);
            // 直接返回，不添加空格
            return hex;
        }

        // 判断数据类型
        function detectDataType(cleanData) {
            const byteLength = cleanData.length / 2;
            
            if (byteLength === 52) {
                // 根据数据特征进一步判断是type1、type2还是type3
                return 'type1'; // 默认返回type1，实际应用中可以根据更多特征判断
            } else if (byteLength === 58) {
                return 'type4';
            }
            
            return 'type1'; // 默认类型
        }

        // 解析单行数据
        function parseData(rawData) {
            const cleanData = cleanHexData(rawData);
            const dataType = detectDataType(cleanData);
            const typeConfig = dataTypes[dataType];
            
            if (!typeConfig) {
                throw new Error('未知的数据类型');
            }

            const result = {
                type: typeConfig.name,
                originalData: rawData,
                cleanData: cleanData,
                fields: []
            };

            typeConfig.fields.forEach(field => {
                const hexValue = extractBytes(cleanData, field.start, field.end);
                const decValue = hexToDec(hexValue);
                
                // 简化字节范围显示
                let rangeText;
                if (field.start === field.end) {
                    rangeText = `${field.start + 1}`;
                } else {
                    rangeText = `${field.start + 1}~${field.end + 1}`;
                }
                
                result.fields.push({
                    name: field.name,
                    hexValue: hexValue,
                    decValue: decValue,
                    range: rangeText
                });
            });

            // 添加校验码验证
            try {
                // 计算校验和：除去最后4个数字(2个字节)外，其余所有数字，每2个数字相加组成的和
                const dataWithoutChecksum = cleanData.substring(0, cleanData.length - 4);
                let checksum = 0;
                
                // 每2个字符（1个字节）相加
                for (let i = 0; i < dataWithoutChecksum.length; i += 2) {
                    if (i + 1 < dataWithoutChecksum.length) {
                        const byte = dataWithoutChecksum.substring(i, i + 2);
                        checksum += parseInt(byte, 16);
                    }
                }
                
                // 取后两位字节（校验码）
                const actualChecksumHex = cleanData.substring(cleanData.length - 4);
                const actualChecksum = parseInt(actualChecksumHex, 16);
                
                // 取校验和的低16位（因为校验码是2字节）
                const calculatedChecksum = checksum & 0xFFFF;
                
                // 验证结果
                const isValid = calculatedChecksum === actualChecksum;
                
                // 添加校验信息到结果
                result.checksum = {
                    calculated: calculatedChecksum,
                    actual: actualChecksum,
                    isValid: isValid
                };
            } catch (e) {
                // 如果计算出错，添加错误信息
                result.checksum = {
                    error: e.message
                };
            }
            
            return result;
        }

        // 分析数据
        function analyzeData() {
            const rawInput = document.getElementById('logInput').value.trim();
            const resultSection = document.querySelector('.result-content');
            const statusSection = document.getElementById('statusSection');
            
            if (!rawInput) {
                statusSection.className = 'status-section error';
                statusSection.textContent = '❌ 请输入原始数据';
                return;
            }

            const lines = rawInput.split('\n').filter(line => line.trim());
            
            // 清空现有结果
            resultSection.innerHTML = '';
            
            if (lines.length === 0) {
                statusSection.className = 'status-section error';
                statusSection.textContent = '❌ 没有找到有效的数据行';
                return;
            }

            let successCount = 0;
            let errorCount = 0;
            
            // 为每条数据创建独立的解析结果块
            lines.forEach((line, index) => {
                try {
                    const parsedData = parseData(line.trim());
                    createResultBlock(parsedData, index);
                    successCount++;
                } catch (error) {
                    // 创建错误结果块
                    const errorBlock = document.createElement('div');
                    errorBlock.className = 'result-item error';
                    errorBlock.innerHTML = `
                        <div class="result-header">
                            📊 解析结果 (第${index + 1}条) - 解析失败
                        </div>
                        <div class="status-section error">
                            ❌ 解析失败: ${error.message}
                        </div>
                        <div class="error-raw-data">
                            <strong>原始日志:</strong> ${line}
                        </div>
                    `;
                    resultSection.appendChild(errorBlock);
                    errorCount++;
                }
            });
            
            // 更新状态区域显示统计信息
            statusSection.className = 'status-section info';
            statusSection.innerHTML = `
                📊 解析完成！成功解析 ${successCount} 条数据，失败 ${errorCount} 条数据。
            `;
        }

        // 创建结果块
        function createResultBlock(parsedData, index) {
            const resultSection = document.querySelector('.result-content');
            
            // 创建结果容器
            const resultBlock = document.createElement('div');
            resultBlock.className = 'result-item';
            resultBlock.style.marginBottom = '20px';
            resultBlock.style.border = '1px solid #e1e5e9';
            resultBlock.style.borderRadius = '10px';
            resultBlock.style.overflow = 'hidden';
            
            // 创建标题栏
            const header = document.createElement('div');
            header.className = 'result-header';
            header.innerHTML = `
                📊 解析结果 (第${index + 1}条) - ${parsedData.type}
            `;
            resultBlock.appendChild(header);
            
            // 创建原始日志显示区域
            const rawDataDiv = document.createElement('div');
            rawDataDiv.style.padding = '10px';
            rawDataDiv.style.backgroundColor = '#f8f9fa';
            rawDataDiv.style.borderBottom = '1px solid #e1e5e9';
            rawDataDiv.innerHTML = `<strong>原始日志:</strong> ${parsedData.originalData}`;
            resultBlock.appendChild(rawDataDiv);
            
            // 创建表格容器
            const tableContainer = document.createElement('div');
            tableContainer.style.overflowX = 'auto';
            tableContainer.style.width = '100%';
            
            // 创建表格
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="row-label">数据类型</th>
                    </tr>
                    <tr>
                        <th class="row-label">范围</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label"><strong>数值</strong></td>
                    </tr>
                </tbody>
            `;
            
            // 更新表格内容
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            const titleRow = thead.children[0];
            const rangeRow = thead.children[1];
            const valueRow = tbody.children[0];
            
            parsedData.fields.forEach(field => {
                // 添加字段标题
                const th = document.createElement('th');
                th.title = field.name;
                th.textContent = field.name;
                titleRow.appendChild(th);
                
                // 添加字节范围
                const rangeTh = document.createElement('th');
                rangeTh.className = 'range-cell';
                rangeTh.textContent = field.range;
                rangeRow.appendChild(rangeTh);
                
                // 添加数值
                const td = document.createElement('td');
                td.className = 'data-cell';
                td.title = `十进制: ${field.decValue}, 十六进制: ${field.hexValue}`;
                // 优化16进制数值显示：最少保留2位数，00显示为00
                let formattedHex;
                if (field.hexValue === '00') {
                    formattedHex = '00'; // 当是00时，保持显示00
                } else {
                    // 去除前导零
                    const trimmed = field.hexValue.replace(/^0+/, '') || '0';
                    // 确保最少保留2位数
                    formattedHex = trimmed.padStart(2, '0');
                }
                td.innerHTML = `<span class="dec-value">${field.decValue}</span><br><span class="hex-value">「${formattedHex}」</span>`;
                valueRow.appendChild(td);
            });
            
            // 添加校验码验证结果列
            if (parsedData.checksum && !parsedData.checksum.error) {
                // 添加校验结果标题
                const checksumTitleTh = document.createElement('th');
                checksumTitleTh.title = '校验码验证';
                checksumTitleTh.textContent = '校验验证';
                titleRow.appendChild(checksumTitleTh);
                
                // 添加空的范围单元格
                const checksumRangeTh = document.createElement('th');
                checksumRangeTh.className = 'range-cell';
                checksumRangeTh.textContent = '-';
                rangeRow.appendChild(checksumRangeTh);
                
                // 添加校验结果
                const checksumTd = document.createElement('td');
                checksumTd.className = 'data-cell';
                checksumTd.style.fontWeight = 'bold';
                checksumTd.style.color = parsedData.checksum.isValid ? '#28a745' : '#dc3545';
                
                // 格式化计算出的校验和为16进制，确保4位
                const calculatedHex = parsedData.checksum.calculated.toString(16).toUpperCase().padStart(4, '0');
                checksumTd.innerHTML = `${calculatedHex}「${parsedData.checksum.isValid ? '✅' : '❌'}」`;
                valueRow.appendChild(checksumTd);
            }
            
            tableContainer.appendChild(table);
            resultBlock.appendChild(tableContainer);
            
            // 添加到结果区域
            resultSection.appendChild(resultBlock);
        }

        // 清空数据
        function clearLogData() {
            document.getElementById('logInput').value = '';
            document.getElementById('statusSection').innerHTML = '';
            document.querySelector('.result-content').innerHTML = '';
        }

        // 绑定事件
        document.getElementById('analyzeBtn').addEventListener('click', analyzeData);
        document.getElementById('clearLogBtn').addEventListener('click', clearLogData);

        // 回车键快捷分析
        document.getElementById('logInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                analyzeData();
            }
        });
        
        // 日志解析界面功能
        function analyzeLog() {
            const logInput = document.getElementById('logInput').value.trim();
            const logResult = document.getElementById('logResult');
            
            if (!logInput) {
                logResult.textContent = '请输入日志数据';
                return;
            }
            
            try {
                console.log('开始解析日志:', logInput); // 调试信息
                
                const result = analysis(logInput);
                
                if (result && result.error) {
                    logResult.textContent = '解析失败：' + result.error;
                    return;
                }
                
                if (result) {
                    let output = '📊 日志解析结果：\n';
                    output += '═'.repeat(50) + '\n\n';
                    
                    // 格式化输出结果
                    for (const [key, value] of Object.entries(result)) {
                        if (value && value.toString().trim()) {
                            output += `${value}\n`;
                        }
                    }
                    
                    output += '\n' + '═'.repeat(50);
                    output += '\n解析完成 ✓';
                    
                    logResult.textContent = output;
                    console.log('解析成功:', result); // 调试信息
                } else {
                    logResult.textContent = '解析失败：无法识别的数据格式';
                }
            } catch (error) {
                logResult.textContent = '解析出错：' + error.message;
                console.error('日志解析错误:', error);
            }
        }
        
        function clearLogData() {
            document.getElementById('logInput').value = '';
            document.getElementById('logResult').textContent = '等待输入日志数据...';
        }
        
        // 处理回车键自动解析
        function handleLogInputKeydown(event) {
            // 检测回车键（Enter键，keyCode为13）
            if (event.key === 'Enter' || event.keyCode === 13) {
                // 阻止默认的换行行为
                event.preventDefault();
                
                // 获取输入框的值
                const logInput = document.getElementById('logInput').value.trim();
                
                // 如果有内容则自动开始解析
                if (logInput) {
                    console.log('🔍 检测到回车键，自动开始解析日志');
                    analyzeLog();
                } else {
                    console.log('⚠️ 输入框为空，无法解析');
                }
            }
        }
        class QRGenerator {
            constructor() {
                this.generatedBlobs = []; // 存储生成的blob对象
                this.initEventListeners();
            }

            initEventListeners() {
                document.getElementById('qrGenerateBtn').addEventListener('click', () => this.generateQRCodes());
                document.getElementById('qrDownloadBtn').addEventListener('click', () => this.downloadZip());
            }

            showError(message) {
                const errorDiv = document.getElementById('qrErrorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            showSuccess(message) {
                const successDiv = document.getElementById('qrSuccessMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }

            updateProgress(current, total, text) {
                const progressContainer = document.getElementById('qrProgressContainer');
                const progressFill = document.getElementById('qrProgressFill');
                const progressText = document.getElementById('qrProgressText');
                
                progressContainer.style.display = 'block';
                const percentage = (current / total) * 100;
                progressFill.style.width = percentage + '%';
                progressText.textContent = text || `正在生成 ${current}/${total} (${Math.round(percentage)}%)`;
            }

            hideProgress() {
                document.getElementById('qrProgressContainer').style.display = 'none';
            }

            updateApiStatus(message, show = true) {
                const apiStatus = document.getElementById('qrApiStatus');
                const apiStatusText = document.getElementById('qrApiStatusText');
                
                if (show) {
                    apiStatus.style.display = 'block';
                    apiStatusText.textContent = message;
                } else {
                    apiStatus.style.display = 'none';
                }
            }

            setGenerateButtonState(loading) {
                const btn = document.getElementById('qrGenerateBtn');
                const btnText = document.getElementById('qrGenerateBtnText');
                const btnLoading = document.getElementById('qrGenerateBtnLoading');
                
                btn.disabled = loading;
                btnText.style.display = loading ? 'none' : 'inline';
                btnLoading.style.display = loading ? 'inline-block' : 'none';
            }

            // 生成带自适应IMEI文字的二维码（带重试机制）
            async generateQRCode(text, imei, retryCount = 0) {
                const encodedText = encodeURIComponent(text);
                const maxRetries = 2;
                
                // 多个备选API，提高成功率
                const apis = [
                    `https://api.qrserver.com/v1/create-qr-code/?size=280x280&format=png&data=${encodedText}`,
                    `https://chart.googleapis.com/chart?chs=280x280&cht=qr&chl=${encodedText}`,
                    `https://quickchart.io/qr?text=${encodedText}&size=280`
                ];
                
                const currentApi = apis[retryCount % apis.length];
                console.log(`🔄 ${imei} 尝试API ${retryCount + 1}/${maxRetries + 1}:`, currentApi);
                
                try {
                    // 创建带自适应IMEI文字的二维码图片
                    return await this.addTextToQRCode(currentApi, imei);
                } catch (error) {
                    console.log(`❌ ${imei} API失败 (${retryCount + 1}/${maxRetries + 1}):`, error.message);
                    
                    if (retryCount < maxRetries) {
                        console.log(`🔄 ${imei} 重试中...`);
                        await new Promise(resolve => setTimeout(resolve, 200)); // 短暂延迟
                        return await this.generateQRCode(text, imei, retryCount + 1);
                    } else {
                        throw new Error(`所有API都失败: ${error.message}`);
                    }
                }
            }

            // 在二维码图片上添加自适应IMEI文字
            async addTextToQRCode(qrUrl, imei) {
                console.log(`🖼️ 开始处理: ${imei}`);
                
                // 尝试多种方法获取图片
                const methods = [
                    // 方法1: 使用代理服务器
                    async () => {
                        const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(qrUrl)}`);
                        if (!response.ok) throw new Error(`代理服务器错误: ${response.status}`);
                        return await response.blob();
                    },
                    // 方法2: 使用另一个代理
                    async () => {
                        const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(qrUrl)}`);
                        if (!response.ok) throw new Error(`代理服务器错误: ${response.status}`);
                        return await response.blob();
                    },
                    // 方法3: 直接尝试（可能会有跨域问题，但有些浏览器允许）
                    async () => {
                        const response = await fetch(qrUrl);
                        if (!response.ok) throw new Error(`直接请求错误: ${response.status}`);
                        return await response.blob();
                    }
                ];
                
                let imageBlob = null;
                let lastError = null;
                
                // 尝试每种方法
                for (let i = 0; i < methods.length; i++) {
                    try {
                        console.log(`🔄 ${imei} 尝试方法 ${i + 1}/${methods.length}`);
                        imageBlob = await methods[i]();
                        console.log(`✅ ${imei} 方法 ${i + 1} 成功获取图片`);
                        break;
                    } catch (error) {
                        console.log(`❌ ${imei} 方法 ${i + 1} 失败:`, error.message);
                        lastError = error;
                        continue;
                    }
                }
                
                if (!imageBlob) {
                    throw new Error(`所有获取图片的方法都失败: ${lastError?.message}`);
                }
                
                const imageUrl = URL.createObjectURL(imageBlob);
                
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    
                    const timeout = setTimeout(() => {
                        console.log(`⏰ ${imei} 处理超时`);
                        URL.revokeObjectURL(imageUrl);
                        reject(new Error('处理超时'));
                    }, 10000);
                    
                    img.onload = () => {
                        clearTimeout(timeout);
                        console.log(`✅ ${imei} 图片加载成功`);
                        
                        try {
                            // 创建canvas
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            if (!ctx) {
                                throw new Error('无法创建Canvas上下文');
                            }
                            
                            // 设置画布尺寸为正方形
                            const qrSize = 280;
                            const textHeight = 80;
                            const totalSize = qrSize + textHeight;
                            
                            canvas.width = totalSize;
                            canvas.height = totalSize;
                            
                            // 填充白色背景
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, totalSize, totalSize);
                            
                            // 绘制二维码（居中上方）
                            const qrX = (totalSize - qrSize) / 2;
                            const qrY = 10;
                            ctx.drawImage(img, qrX, qrY, qrSize, qrSize);
                            
                            // 自适应文字大小到二维码宽度
                            const maxWidth = qrSize - 20;
                            let fontSize = 50;
                            const minFontSize = 24;
                            
                            // 设置文字样式
                            ctx.fillStyle = '#333333';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            
                            // 动态调整字体大小
                            do {
                                ctx.font = `bold ${fontSize}px Arial, sans-serif`;
                                const textWidth = ctx.measureText(imei).width;
                                
                                if (textWidth <= maxWidth || fontSize <= minFontSize) {
                                    break;
                                }
                                fontSize -= 1;
                            } while (fontSize > minFontSize);
                            
                            fontSize = Math.max(fontSize, minFontSize);
                            ctx.font = `bold ${fontSize}px Arial, sans-serif`;
                            
                            // 绘制IMEI文字
                            const textY = qrY + qrSize + textHeight / 2;
                            ctx.fillText(imei, totalSize / 2, textY);
                            
                            console.log(`📏 ${imei} 字体: ${fontSize}px`);
                            
                            // 转换为blob
                            canvas.toBlob((resultBlob) => {
                                if (resultBlob) {
                                    const url = URL.createObjectURL(resultBlob);
                                    this.generatedBlobs.push({ blob: resultBlob, filename: `${imei}.png` });
                                    console.log(`🎉 ${imei} 处理完成`);
                                    
                                    // 清理临时URL
                                    URL.revokeObjectURL(imageUrl);
                                    resolve(url);
                                } else {
                                    URL.revokeObjectURL(imageUrl);
                                    reject(new Error('Canvas转换失败'));
                                }
                            }, 'image/png');
                            
                        } catch (error) {
                            console.error(`❌ ${imei} Canvas处理失败:`, error);
                            URL.revokeObjectURL(imageUrl);
                            reject(error);
                        }
                    };
                    
                    img.onerror = (error) => {
                        clearTimeout(timeout);
                        console.error(`❌ ${imei} 图片加载失败:`, error);
                        URL.revokeObjectURL(imageUrl);
                        reject(new Error('图片加载失败'));
                    };
                    
                    img.src = imageUrl;
                });
            }

            async generateQRCodes() {
                const prefix = document.getElementById('qrPrefix').value.trim();
                const imeiText = document.getElementById('qrImeiList').value.trim();
                
                if (!prefix) {
                    this.showError('请输入二维码前缀');
                    return;
                }
                
                if (!imeiText) {
                    this.showError('请输入IMEI列表');
                    return;
                }

                const imeiList = imeiText.split('\n').filter(imei => imei.trim()).map(imei => imei.trim());
                
                if (imeiList.length === 0) {
                    this.showError('请输入有效的IMEI列表');
                    return;
                }

                this.setGenerateButtonState(true);
                this.generatedBlobs = [];
                document.getElementById('qrGrid').innerHTML = '';
                document.getElementById('qrDownloadBtn').disabled = true;
                this.updateApiStatus('使用QR-Server.com API生成二维码...');

                let successCount = 0;
                let failCount = 0;

                for (let i = 0; i < imeiList.length; i++) {
                    const imei = imeiList[i];
                    const qrText = prefix + imei;
                    
                    this.updateProgress(i + 1, imeiList.length, `正在生成 ${i + 1}/${imeiList.length}: ${imei}`);
                    
                    try {
                        const qrUrl = await this.generateQRCode(qrText, imei);
                        await this.displayQRCode(qrUrl, imei, qrText);
                        successCount++;
                        
                        // 减少延迟时间，提高生成速度
                        if (i < imeiList.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    } catch (error) {
                        console.error(`生成 ${imei} 的二维码失败:`, error);
                        failCount++;
                        this.displayErrorQR(imei, error.message);
                    }
                }

                this.hideProgress();
                this.setGenerateButtonState(false);
                
                if (successCount > 0) {
                    document.getElementById('qrDownloadBtn').disabled = false;
                    this.updateApiStatus(`✅ 成功生成 ${successCount} 个二维码${failCount > 0 ? `，失败 ${failCount} 个` : ''}`);
                    this.showSuccess(`成功生成 ${successCount} 个二维码${failCount > 0 ? `，失败 ${failCount} 个` : ''}`);
                } else {
                    this.updateApiStatus('❌ 所有二维码生成失败');
                    this.showError('所有二维码生成失败，请检查网络连接或稍后重试');
                }
            }

            async displayQRCode(qrUrl, imei, qrText) {
                return new Promise((resolve, reject) => {
                    const qrItem = document.createElement('div');
                    qrItem.className = 'qr-item';
                    
                    // 创建图片元素并等待加载
                    const img = new Image();
                    img.onload = () => {
                        qrItem.innerHTML = `
                            <img src="${qrUrl}" alt="QR Code for ${imei}">
                            <div class="qr-label">${imei}</div>
                            <div class="qr-label" style="font-size: 0.7em; color: #999; margin-top: 5px;">${qrText}</div>
                            <div class="qr-label" style="font-size: 0.6em; color: #4facfe; margin-top: 3px;">API: QR-Server.com</div>
                        `;
                        
                        document.getElementById('qrGrid').appendChild(qrItem);
                        resolve();
                    };
                    
                    img.onerror = () => {
                        reject(new Error('二维码图片加载失败'));
                    };
                    
                    img.src = qrUrl;
                });
            }

            displayErrorQR(imei, errorMsg) {
                const qrItem = document.createElement('div');
                qrItem.className = 'qr-item';
                qrItem.style.background = '#ffe6e6';
                qrItem.innerHTML = `
                    <div style="padding: 20px; color: #d63031;">
                        <div style="font-size: 2em; margin-bottom: 10px;">❌</div>
                        <div class="qr-label">${imei}</div>
                        <div style="font-size: 0.8em; margin-top: 5px;">${errorMsg}</div>
                    </div>
                `;
                
                document.getElementById('qrGrid').appendChild(qrItem);
            }

            async downloadZip() {
                if (this.generatedBlobs.length === 0) {
                    this.showError('没有可下载的二维码');
                    return;
                }

                const zip = new JSZip();
                const downloadBtn = document.getElementById('qrDownloadBtn');
                const originalText = downloadBtn.textContent;
                
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = '<span class="loading"></span> 正在打包...';

                try {
                    // 处理生成的图片
                    for (let i = 0; i < this.generatedBlobs.length; i++) {
                        const item = this.generatedBlobs[i];
                        zip.file(item.filename, item.blob);
                        downloadBtn.textContent = `正在打包 ${i + 1}/${this.generatedBlobs.length}`;
                    }

                    downloadBtn.textContent = '正在生成压缩包...';
                    const content = await zip.generateAsync({type: 'blob'});
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `二维码_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.zip`;
                    link.click();
                    
                    URL.revokeObjectURL(link.href);
                    this.showSuccess('二维码打包下载成功！');
                    
                } catch (error) {
                    console.error('打包下载失败:', error);
                    this.showError('打包下载失败: ' + error.message);
                } finally {
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = originalText;
                }
            }
        }

        // 初始化二维码生成器
        let qrGenerator = null;
        function initQRGenerator() {
            if (!qrGenerator) {
                qrGenerator = new QRGenerator();
            }
        }

        // 在显示工具时初始化
        function showTool(toolId) {
            // 隐藏所有工具
            document.querySelectorAll('.calculator').forEach(tool => {
                tool.style.display = 'none';
            });
            
            // 显示选中的工具
            const selectedTool = document.getElementById(toolId);
            if (selectedTool) {
                selectedTool.style.display = 'block';
                
                // 如果是二维码生成器，初始化它
                if (toolId === 'qrGeneratorTool') {
                    initQRGenerator();
                }
                
                // 如果是日志分析器，可以做一些初始化
            if (toolId === 'logAnalysisTool') {
                // 这里可以添加日志分析器的初始化逻辑
                console.log('日志分析器已激活');
            }
            }
            
            // 更新按钮激活状态
            document.querySelectorAll('.tool-switcher button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tool-switcher button[onclick="showTool('${toolId}')"]`).classList.add('active');
        }
        
    </script>
</body>
</html>

